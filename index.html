<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masjid Management System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Arabic and English -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #14793b;
            --secondary-green: #14db67;
            --light-green: #d5f4e6;
            --gold: #ffc400;
            --cream: #f8f5f0;
            --dark-blue: #006aff;
            --light-blue: #00f7ff;
            --text-dark: #333333;
            --border-color: #dddddd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--cream);
            color: var(--text-dark);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%230d5d2b' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .navbar {
            background-color: var(--primary-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-family: 'Amiri', serif;
            font-weight: 700;
            color: var(--gold) !important;
            font-size: 1.8rem;
        }
        
        .nav-link {
            color: var(--cream) !important;
            font-weight: 500;
            margin: 0 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--gold) !important;
        }
        
        .nav-link.active {
            background-color: var(--secondary-green);
            color: var(--gold) !important;
        }
        
        .section {
            display: none;
            padding: 30px 0;
        }
        
        .section.active {
            display: block;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary-green);
            color: var(--cream);
            font-weight: 600;
            padding: 15px 20px;
            border-bottom: 2px solid var(--gold);
        }
        
        .card-header h5 {
            margin: 0;
            font-family: 'Amiri', serif;
            font-size: 1.4rem;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-green);
            border-color: var(--secondary-green);
        }
        
        .btn-outline-primary {
            color: var(--primary-green);
            border-color: var(--primary-green);
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
        }
        
        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 10px 15px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.25rem rgba(13, 93, 43, 0.25);
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--light-green);
            color: var(--primary-green);
            font-weight: 600;
            border: none;
        }
        
        .table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        .table tbody tr:last-child {
            border-bottom: none;
        }
        
        .badge {
            padding: 5px 10px;
            font-weight: 500;
        }
        
        .logo-preview {
            width: 120px;
            height: 120px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            overflow: hidden;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .arabic-calligraphy {
            font-family: 'Amiri', serif;
            text-align: center;
            margin: 20px 0;
            color: var(--primary-green);
            font-size: 1.8rem;
        }
        
        .islamic-pattern {
            height: 40px;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%230d5d2b' fill-opacity='0.2'%3E%3Cpath d='M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z'/%3E%3C/g%3E%3C/svg%3E");
            margin: 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .preview-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .preview-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .islamic-pdf-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gold);
        }
        
        .islamic-pdf-header h2 {
            color: var(--primary-green);
            font-family: 'Amiri', serif;
            margin-bottom: 5px;
        }
        
        .islamic-pdf-header .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 1.5rem;
            color: var(--dark-blue);
        }
        
        .islamic-pdf-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: #000000;
        }
        
        .amount-input {
            position: relative;
        }
        
        .amount-input::before {
            content: "₹";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: 500;
        }
        
        .amount-input input {
            padding-left: 30px;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-upload:hover .file-upload-label {
            background-color: #e9ecef;
            border-color: var(--primary-green);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-icon {
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .toast-success .toast-icon {
            color: var(--secondary-green);
        }
        
        .toast-error .toast-icon {
            color: #dc3545;
        }
        
        .toast-message {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #999;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Summary Card Styles */
        .summary-card {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            font-family: 'Amiri', serif;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .summary-item.income {
            color: #d4edda;
        }
        
        .summary-item.expense {
            color: #f8d7da;
        }
        
        .summary-item.balance {
            color: #fff3cd;
        }
        
        .summary-item.positive {
            color: #d4edda;
        }
        
        .summary-item.negative {
            color: #f8d7da;
        }
        
        .file-attachments {
            margin-top: 15px;
        }
        
        .file-attachment-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .file-attachment-item i {
            margin-right: 10px;
            color: var(--primary-green);
        }
        
        .file-attachment-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-attachment-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
        }
        
        /* Pending Chanda Alert Styles */
        .pending-chanda-card {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .pending-chanda-card h3 {
            font-family: 'Amiri', serif;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .pending-chanda-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .pending-chanda-item:last-child {
            margin-bottom: 0;
        }
        
        .pending-chanda-actions {
            display: flex;
            gap: 5px;
        }
        
        /* WhatsApp Settings Styles */
        .whatsapp-settings {
            background-color: #eaf6ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .whatsapp-number-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .whatsapp-number-input input {
            flex: 1;
            margin-left: 10px;
        }
        
        .whatsapp-preview {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #ddd;
        }
        
        .whatsapp-message {
            background-color: #dcf8c6;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .whatsapp-message::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #dcf8c6;
            transform: rotate(180deg);
        }
        
        .whatsapp-timestamp {
            font-size: 0.75rem;
            color: #999;
            text-align: right;
            margin-top: 5px;
        }
        
        /* Chanda Receipt Styles */
        .islamic-receipt {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid var(--primary-green);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: 'Amiri', serif;
            color: #333;
        }
        
        .islamic-receipt-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed var(--primary-green);
        }
        
        .islamic-receipt-header h2 {
            color: var(--primary-green);
            margin-bottom: 5px;
            font-size: 1.8rem;
        }
        
        .islamic-receipt-header .arabic-text {
            font-size: 1.5rem;
            color: var(--dark-blue);
            margin-bottom: 10px;
        }
        
        .islamic-receipt-masjid-info {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .islamic-receipt-masjid-info h3 {
            margin: 0;
            font-size: 1.4rem;
            color: var(--primary-green);
        }
        
        .islamic-receipt-masjid-info p {
            margin: 5px 0;
            font-size: 0.9rem;
        }
        
        .islamic-receipt-content {
            margin: 20px 0;
        }
        
        .islamic-receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .islamic-receipt-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--primary-green);
        }
        
        .islamic-receipt-label {
            font-weight: 600;
        }
        
        .islamic-receipt-value {
            text-align: right;
        }
        
        .islamic-receipt-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-green);
        }
        
        .islamic-receipt-amount-words {
            text-align: center;
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }
        
        .islamic-receipt-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 0.9rem;
            color: #666;
        }
        
        .islamic-receipt-seal {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .islamic-receipt-seal-left, .islamic-receipt-seal-right {
            width: 45%;
            text-align: center;
        }
        
        .islamic-receipt-seal-line {
            height: 1px;
            background-color: #333;
            margin: 30px 0 5px;
        }
        
        .islamic-receipt-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Announcement Image Styles */
        .announcement-image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                flex: none;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .islamic-receipt-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">مَسْجِدْ مَانَيْجِمِنْتْ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="masjid-info">
                            <i class="fas fa-mosque me-1"></i> Masjid Info
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="committee">
                            <i class="fas fa-users me-1"></i> Committee
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="donations">
                            <i class="fas fa-donate me-1"></i> Donations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="construction">
                            <i class="fas fa-hammer me-1"></i> Construction
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="announcements">
                            <i class="fas fa-bullhorn me-1"></i> Announcements
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="chanda">
                            <i class="fas fa-hand-holding-heart me-1"></i> Chanda
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="pending-chanda">
                            <i class="fas fa-exclamation-circle me-1"></i> Pending Chanda
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="summary">
                            <i class="fas fa-chart-pie me-1"></i> Summary
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Masjid Info Section -->
        <section id="masjid-info" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-mosque me-2"></i> Masjid Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="logo-preview" id="logoPreview">
                                <i class="fas fa-mosque fa-3x text-muted"></i>
                            </div>
                            <div class="file-upload">
                                <input type="file" id="logoUpload" accept="image/*">
                                <label for="logoUpload" class="file-upload-label">
                                    <i class="fas fa-upload me-2"></i> Upload Logo
                                </label>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <form id="masjidInfoForm">
                                <div class="mb-3">
                                    <label for="masjidName" class="form-label">Masjid Name</label>
                                    <input type="text" class="form-control" id="masjidName" placeholder="Enter masjid name">
                                </div>
                                <div class="mb-3">
                                    <label for="masjidAddress" class="form-label">Address</label>
                                    <textarea class="form-control" id="masjidAddress" rows="3" placeholder="Enter masjid address"></textarea>
                                </div>
                                
                                <!-- WhatsApp Settings -->
                                <div class="whatsapp-settings">
                                    <h6><i class="fab fa-whatsapp me-2"></i> WhatsApp Settings</h6>
                                    <p class="small text-muted">Add up to 3 WhatsApp numbers for sending payment reminders</p>
                                    
                                    <div class="whatsapp-number-input">
                                        <label class="form-label mb-0">Number 1:</label>
                                        <input type="tel" class="form-control" id="whatsappNumber1" placeholder="Enter WhatsApp number">
                                    </div>
                                    
                                    <div class="whatsapp-number-input">
                                        <label class="form-label mb-0">Number 2:</label>
                                        <input type="tel" class="form-control" id="whatsappNumber2" placeholder="Enter WhatsApp number">
                                    </div>
                                    
                                    <div class="whatsapp-number-input">
                                        <label class="form-label mb-0">Number 3:</label>
                                        <input type="tel" class="form-control" id="whatsappNumber3" placeholder="Enter WhatsApp number">
                                    </div>
                                </div>
                                
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="resetMasjidInfo">
                                        <i class="fas fa-undo me-2"></i> Reset
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Committee Members Section -->
        <section id="committee" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users me-2"></i> Committee Members & Households</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="mb-3">Add Committee Member</h6>
                            <form id="committeeMemberForm">
                                <div class="mb-3">
                                    <label for="memberName" class="form-label">Member Name</label>
                                    <input type="text" class="form-control" id="memberName" placeholder="Enter member name">
                                </div>
                                <div class="mb-3">
                                    <label for="memberPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="memberPhone" placeholder="Enter phone number">
                                </div>
                                <div class="mb-3">
                                    <label for="memberEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="memberEmail" placeholder="Enter email address">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Add Member
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Add Household</h6>
                            <form id="householdForm">
                                <div class="mb-3">
                                    <label for="householdName" class="form-label">Household Name</label>
                                    <input type="text" class="form-control" id="householdName" placeholder="Enter household name">
                                </div>
                                <div class="mb-3">
                                    <label for="householdAddress" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="householdAddress" placeholder="Enter household address">
                                </div>
                                <div class="mb-3">
                                    <label for="householdPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="householdPhone" placeholder="Enter phone number">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Add Household
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="islamic-pattern"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Committee Members</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="committeeMembersTable">
                                        <!-- Members will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Households</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Address</th>
                                            <th>Phone</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="householdsTable">
                                        <!-- Households will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="mb-3">Link Households to Members</h6>
                        <form id="linkHouseholdForm">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="selectMember" class="form-label">Select Member</label>
                                    <select class="form-select" id="selectMember">
                                        <option value="">-- Select Member --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="selectHousehold" class="form-label">Select Household</label>
                                    <select class="form-select" id="selectHousehold">
                                        <option value="">-- Select Household --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-link me-2"></i> Link
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <div class="mt-4">
                            <h6 class="mb-3">Member-Household Links</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Household</th>
                                            <th>Donation Tracking</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="memberHouseholdLinksTable">
                                        <!-- Links will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-end">
                            <button class="btn btn-primary" id="generateCommitteeReport">
                                <i class="fas fa-file-pdf me-2"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Donations Section -->
        <section id="donations" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-donate me-2"></i> Donations / Monthly Chanda / Jumma Collection</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Add New Donation</h6>
                            <form id="donationForm">
                                <div class="mb-3">
                                    <label for="donorName" class="form-label">Donor Name</label>
                                    <input type="text" class="form-control" id="donorName" placeholder="Enter donor name">
                                </div>
                                <div class="mb-3">
                                    <label for="donationAmount" class="form-label">Amount (₹)</label>
                                    <div class="amount-input">
                                        <input type="number" class="form-control" id="donationAmount" placeholder="0.00" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="donationDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="donationDate">
                                </div>
                                <div class="mb-3">
                                    <label for="donationType" class="form-label">Donation Type</label>
                                    <select class="form-select" id="donationType">
                                        <option value="general">General Donation</option>
                                        <option value="monthly">Monthly Chanda</option>
                                        <option value="jumma">Jumma Collection</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="responsibleMember" class="form-label">Responsible Member</label>
                                    <select class="form-select" id="responsibleMember">
                                        <option value="">-- Select Member --</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="donationReceipt" class="form-label">Upload Receipt/Bill</label>
                                    <div class="file-upload">
                                        <input type="file" id="donationReceipt" accept="image/*">
                                        <label for="donationReceipt" class="file-upload-label">
                                            <i class="fas fa-upload me-2"></i> Upload Receipt
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Add Donation
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Donation Summary</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Total (₹)</th>
                                            <th>Count</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="donationSummaryTable">
                                        <tr>
                                            <td>General</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-donation-report" data-type="general">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Monthly Chanda</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-donation-report" data-type="monthly">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Jumma Collection</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-donation-report" data-type="jumma">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total</strong></td>
                                            <td><strong>0.00</strong></td>
                                            <td><strong>0</strong></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-donation-report" data-type="all">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="mb-3">Recent Donations</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Donor</th>
                                                <th>Amount (₹)</th>
                                                <th>Type</th>
                                                <th>Member</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentDonationsTable">
                                            <!-- Donations will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Construction Budget & Expenses Section -->
        <section id="construction" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-hammer me-2"></i> Construction Budget & Expenses</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="mb-3">Add Construction Donation</h6>
                            <form id="constructionDonationForm">
                                <div class="mb-3">
                                    <label for="constructionDonor" class="form-label">Donor Name</label>
                                    <input type="text" class="form-control" id="constructionDonor" placeholder="Enter donor name">
                                </div>
                                <div class="mb-3">
                                    <label for="constructionDonationAmount" class="form-label">Amount (₹)</label>
                                    <div class="amount-input">
                                        <input type="number" class="form-control" id="constructionDonationAmount" placeholder="0.00" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="constructionDonationDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="constructionDonationDate">
                                </div>
                                <div class="mb-3">
                                    <label for="constructionDonationReceipt" class="form-label">Upload Receipt</label>
                                    <div class="file-upload">
                                        <input type="file" id="constructionDonationReceipt" accept="image/*">
                                        <label for="constructionDonationReceipt" class="file-upload-label">
                                            <i class="fas fa-upload me-2"></i> Upload Receipt
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Add Donation
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Add Construction Expense</h6>
                            <form id="constructionExpenseForm">
                                <div class="mb-3">
                                    <label for="expenseDescription" class="form-label">Expense Description</label>
                                    <input type="text" class="form-control" id="expenseDescription" placeholder="Enter expense description">
                                </div>
                                <div class="mb-3">
                                    <label for="expenseAmount" class="form-label">Amount (₹)</label>
                                    <div class="amount-input">
                                        <input type="number" class="form-control" id="expenseAmount" placeholder="0.00" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="expenseDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="expenseDate">
                                </div>
                                <div class="mb-3">
                                    <label for="expenseBill" class="form-label">Upload Bill</label>
                                    <div class="file-upload">
                                        <input type="file" id="expenseBill" accept="image/*">
                                        <label for="expenseBill" class="file-upload-label">
                                            <i class="fas fa-upload me-2"></i> Upload Bill
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Add Expense
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="islamic-pattern"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Construction Donations</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Donor</th>
                                            <th>Amount (₹)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="constructionDonationsTable">
                                        <!-- Donations will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2 text-end">
                                <strong>Total Donations: ₹<span id="totalConstructionDonations">0.00</span></strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Construction Expenses</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount (₹)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="constructionExpensesTable">
                                        <!-- Expenses will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2 text-end">
                                <strong>Total Expenses: ₹<span id="totalConstructionExpenses">0.00</span></strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="mb-3">Construction Budget Summary</h6>
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <h3 class="text-success">₹<span id="budgetTotalDonations">0.00</span></h3>
                                        <p>Total Donations</p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <h3 class="text-danger">₹<span id="budgetTotalExpenses">0.00</span></h3>
                                        <p>Total Expenses</p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <h3 class="text-primary">₹<span id="budgetRemaining">0.00</span></h3>
                                        <p>Remaining Budget</p>
                                    </div>
                                </div>
                                <div class="mt-3 text-end">
                                    <button class="btn btn-primary" id="generateConstructionReport">
                                        <i class="fas fa-file-pdf me-2"></i> Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Announcements Section -->
        <section id="announcements" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bullhorn me-2"></i> Quick Announcements / Updates</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Create Announcement</h6>
                            <form id="announcementForm">
                                <div class="mb-3">
                                    <label for="announcementTitle" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="announcementTitle" placeholder="Enter announcement title">
                                </div>
                                <div class="mb-3">
                                    <label for="announcementContent" class="form-label">Content</label>
                                    <textarea class="form-control" id="announcementContent" rows="5" placeholder="Enter announcement content"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="announcementDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="announcementDate">
                                </div>
                                <div class="mb-3">
                                    <label for="announcementPriority" class="form-label">Priority</label>
                                    <select class="form-select" id="announcementPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="announcementImage" class="form-label">Upload Image (Optional)</label>
                                    <div class="file-upload">
                                        <input type="file" id="announcementImage" accept="image/*">
                                        <label for="announcementImage" class="file-upload-label">
                                            <i class="fas fa-upload me-2"></i> Upload Image
                                        </label>
                                    </div>
                                    <div id="announcementImagePreview" class="mt-2"></div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Create Announcement
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Recent Announcements</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Title</th>
                                            <th>Priority</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="announcementsTable">
                                        <!-- Announcements will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="islamic-pattern"></div>
                    
                    <div class="mt-4">
                        <h6 class="mb-3">Announcement Preview</h6>
                        <div class="card">
                            <div class="card-body" id="announcementPreview">
                                <div class="text-center text-muted">
                                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                                    <p>Select an announcement to preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chanda Collection Section -->
        <section id="chanda" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-hand-holding-heart me-2"></i> Chanda Collection Management</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Add Chanda Collection</h6>
                            <form id="chandaForm">
                                <div class="mb-3">
                                    <label for="chandaDonor" class="form-label">Donor Name</label>
                                    <input type="text" class="form-control" id="chandaDonor" placeholder="Enter donor name">
                                </div>
                                <div class="mb-3">
                                    <label for="chandaAmount" class="form-label">Amount (₹)</label>
                                    <div class="amount-input">
                                        <input type="number" class="form-control" id="chandaAmount" placeholder="0.00" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="chandaDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="chandaDate">
                                </div>
                                <div class="mb-3">
                                    <label for="chandaCollector" class="form-label">Collector</label>
                                    <select class="form-select" id="chandaCollector">
                                        <option value="">-- Select Collector --</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="chandaPurpose" class="form-label">Purpose</label>
                                    <select class="form-select" id="chandaPurpose">
                                        <option value="general">General</option>
                                        <option value="maintenance">Masjid Maintenance</option>
                                        <option value="education">Islamic Education</option>
                                        <option value="charity">Charity</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="chandaNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="chandaNotes" rows="2" placeholder="Additional notes (optional)"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i> Add Collection
                                </button>
                                <button type="button" class="btn btn-outline-primary ms-2" id="generateReceiptPreview">
                                    <i class="fas fa-eye me-2"></i> Preview Receipt
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Chanda Collection Summary</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Purpose</th>
                                            <th>Total (₹)</th>
                                            <th>Count</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="chandaSummaryTable">
                                        <tr>
                                            <td>General</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-chanda-report" data-purpose="general">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Masjid Maintenance</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-chanda-report" data-purpose="maintenance">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Islamic Education</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-chanda-report" data-purpose="education">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Charity</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-chanda-report" data-purpose="charity">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Other</td>
                                            <td>0.00</td>
                                            <td>0</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-chanda-report" data-purpose="other">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total</strong></td>
                                            <td><strong>0.00</strong></td>
                                            <td><strong>0</strong></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary generate-chanda-report" data-purpose="all">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="mb-3">Recent Collections</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Donor</th>
                                                <th>Amount (₹)</th>
                                                <th>Purpose</th>
                                                <th>Collector</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentChandaTable">
                                            <!-- Collections will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="islamic-receipt" id="chandaReceipt" style="display: none;">
                            <div class="islamic-receipt-header">
                                <h2>चंदा रसीद / CHANDA RECEIPT</h2>
                                <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                            </div>
                            
                            <div class="islamic-receipt-masjid-info">
                                <h3 id="receiptMasjidName">मस्जिद का नाम / MASJID NAME</h3>
                                <p id="receiptMasjidAddress">मस्जिद का पता / MASJID ADDRESS</p>
                            </div>
                            
                            <div class="islamic-receipt-content">
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">रसीद नंबर / Receipt No.</div>
                                    <div class="islamic-receipt-value" id="receiptNumber">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">तिथि / Date</div>
                                    <div class="islamic-receipt-value" id="receiptDate">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">दाता का नाम / Donor Name</div>
                                    <div class="islamic-receipt-value" id="receiptDonorName">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">पता / Address</div>
                                    <div class="islamic-receipt-value" id="receiptDonorAddress">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">फोन नंबर / Phone</div>
                                    <div class="islamic-receipt-value" id="receiptDonorPhone">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">उद्देश्य / Purpose</div>
                                    <div class="islamic-receipt-value" id="receiptPurpose">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">एकत्रित करने वाला / Collector</div>
                                    <div class="islamic-receipt-value" id="receiptCollector">-</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">राशि (अंकों में) / Amount (in figures)</div>
                                    <div class="islamic-receipt-value islamic-receipt-amount" id="receiptAmount">₹0.00</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">राशि (शब्दों में) / Amount (in words)</div>
                                    <div class="islamic-receipt-value" id="receiptAmountInWords">Zero Rupees Only</div>
                                </div>
                                <div class="islamic-receipt-row">
                                    <div class="islamic-receipt-label">टिप्पणियाँ / Notes</div>
                                    <div class="islamic-receipt-value" id="receiptNotes">-</div>
                                </div>
                            </div>
                            
                            <div class="islamic-receipt-amount-words" id="receiptQrCode"></div>
                            
                            <div class="islamic-receipt-footer">
                                <p>यह रसीद केवल आपके द्वारा दिए गए चंदा के लिए है।</p>
                                <p>This receipt is only for the chanda given by you.</p>
                                <p>धन्यवाद / Thank You</p>
                            </div>
                            
                            <div class="islamic-receipt-seal">
                                <div class="islamic-receipt-seal-left">
                                    <div class="islamic-receipt-seal-line"></div>
                                    <p>दाता के हस्ताक्षर / Donor's Signature</p>
                                </div>
                                <div class="islamic-receipt-seal-right">
                                    <div class="islamic-receipt-seal-line"></div>
                                    <p>मस्जिद प्रबंधन की मुहर / Masjid Management Seal</p>
                                </div>
                            </div>
                            
                            <div class="islamic-receipt-actions">
                                <button class="btn btn-primary" id="downloadReceiptImage">
                                    <i class="fas fa-download me-2"></i> Download as Image
                                </button>
                                <button class="btn btn-success" id="shareReceiptWhatsApp">
                                    <i class="fab fa-whatsapp me-2"></i> Share on WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pending Chanda Section -->
        <section id="pending-chanda" class="section">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-exclamation-circle me-2"></i> Pending Chanda Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="pending-chanda-card">
                        <h3>किसका किसका चंदा बाकी है?</h3>
                        <p class="text-center mb-3">उन सभी लोगों की सूची जिन्होंने अभी तक चंदा नहीं दिया है</p>
                        
                        <div id="pendingChandaList">
                            <!-- Pending chanda items will be added here dynamically -->
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-success" id="sendWhatsAppAlerts">
                                <i class="fab fa-whatsapp me-2"></i> Send WhatsApp Alerts
                            </button>
                            <button class="btn btn-outline-primary ms-2" id="refreshPendingChanda">
                                <i class="fas fa-sync-alt me-2"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>WhatsApp Message Preview</h6>
                        <div class="whatsapp-preview">
                            <div class="whatsapp-message">
                                <p id="whatsappMessagePreview">अस्सलामवलैकुम [नाम],</p>
                                <p>आपका मासिक चंदा ₹[राशि] अभी तक जमा नहीं हुआ है। कृपया जल्द से जल्द अपना चंदा जमा करवाएं।</p>
                                <p>शुक्रिया,<br>[मस्जिद का नाम]</p>
                                <div class="whatsapp-timestamp">Today, 10:30 AM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Summary Section -->
        <section id="summary" class="section active">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie me-2"></i> Total Summary & Reports</h5>
                </div>
                <div class="card-body">
                    <div class="summary-card">
                        <h3>मस्जिद का पूरा हिसाब किताब:--</h3>
                        <div class="summary-item income">
                            <span>जुम्मा कलेक्शन:</span>
                            <span>₹<span id="summaryJummaCollection">0.00</span></span>
                        </div>
                        <div class="summary-item income">
                            <span>मासिक चंदा:</span>
                            <span>₹<span id="summaryMonthlyChanda">0.00</span></span>
                        </div>
                        <div class="summary-item income">
                            <span>सामान्य चंदा:</span>
                            <span>₹<span id="summaryGeneralDonations">0.00</span></span>
                        </div>
                        <div class="summary-item income">
                            <span>निर्माण चंदा:</span>
                            <span>₹<span id="summaryConstructionDonations">0.00</span></span>
                        </div>
                        <div class="summary-item income">
                            <span>चंदा संग्रह:</span>
                            <span>₹<span id="summaryChandaCollections">0.00</span></span>
                        </div>
                        <div class="summary-item income">
                            <span>कुल आय:</span>
                            <span>₹<span id="summaryTotalIncome">0.00</span></span>
                        </div>
                        <div class="summary-item expense">
                            <span>निर्माण खर्च:</span>
                            <span>₹<span id="summaryConstructionExpenses">0.00</span></span>
                        </div>
                        <div class="summary-item expense">
                            <span>कुल खर्च:</span>
                            <span>₹<span id="summaryTotalExpenses">0.00</span></span>
                        </div>
                        <div class="summary-item balance">
                            <span>कुल बचत:</span>
                            <span>₹<span id="summaryTotalBalance">0.00</span></span>
                        </div>
                    </div>
                    
                    <div class="islamic-pattern"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6>वित्तीय रिपोर्ट जनरेट करें</h6>
                                </div>
                                <div class="card-body">
                                    <form id="financialReportForm">
                                        <div class="mb-3">
                                            <label for="reportDateRange" class="form-label">तिथि सीमा</label>
                                            <select class="form-select" id="reportDateRange">
                                                <option value="all">सभी रिकॉर्ड</option>
                                                <option value="currentMonth">वर्तमान महीना</option>
                                                <option value="lastMonth">पिछला महीना</option>
                                                <option value="currentYear">वर्तमान वर्ष</option>
                                                <option value="custom">कस्टम</option>
                                            </select>
                                        </div>
                                        <div class="row mb-3" id="customDateRange" style="display: none;">
                                            <div class="col-md-6">
                                                <label for="reportStartDate" class="form-label">प्रारंभ तिथि</label>
                                                <input type="date" class="form-control" id="reportStartDate">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="reportEndDate" class="form-label">अंतिम तिथि</label>
                                                <input type="date" class="form-control" id="reportEndDate">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="reportIncludeSections" class="form-label">शामिल करने के लिए सेक्शन</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeDonations" checked>
                                                <label class="form-check-label" for="includeDonations">
                                                    दान / जुम्मा कलेक्शन
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeConstruction" checked>
                                                <label class="form-check-label" for="includeConstruction">
                                                    निर्माण बजट और खर्च
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeChanda" checked>
                                                <label class="form-check-label" for="includeChanda">
                                                    चंदा संग्रह
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="reportAttachments" class="form-label">अतिरिक्त अटैचमेंट्स</label>
                                            <div class="file-upload">
                                                <input type="file" id="reportAttachments" multiple accept="image/*,.pdf,.doc,.docx">
                                                <label for="reportAttachments" class="file-upload-label">
                                                    <i class="fas fa-paperclip me-2"></i> फाइलें अटैच करें
                                                </label>
                                            </div>
                                            <div id="attachmentList" class="file-attachments mt-2"></div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-file-pdf me-2"></i> रिपोर्ट जनरेट करें
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6>त्वरित रिपोर्ट्स</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" id="generateMonthlyReport">
                                            <i class="fas fa-calendar-alt me-2"></i> मासिक रिपोर्ट
                                        </button>
                                        <button class="btn btn-outline-primary" id="generateQuarterlyReport">
                                            <i class="fas fa-calendar me-2"></i> त्रैमासिक रिपोर्ट
                                        </button>
                                        <button class="btn btn-outline-primary" id="generateAnnualReport">
                                            <i class="fas fa-calendar-year me-2"></i> वार्षिक रिपोर्ट
                                        </button>
                                        <button class="btn btn-outline-primary" id="generateCustomReport">
                                            <i class="fas fa-file-alt me-2"></i> कस्टम रिपोर्ट
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h6>वित्तीय अवलोकन</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="financialChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="preview-content" id="previewContent">
                        <!-- Preview content will be added here dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadPdf">
                        <i class="fas fa-download me-2"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div class="modal fade" id="whatsappModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send WhatsApp Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="whatsappNumberSelect" class="form-label">Select WhatsApp Number</label>
                        <select class="form-select" id="whatsappNumberSelect">
                            <option value="">-- Select Number --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="whatsappMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="whatsappMessage" rows="5"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message Preview</label>
                        <div class="whatsapp-preview">
                            <div class="whatsapp-message">
                                <p id="whatsappPreviewText">Message preview will appear here</p>
                                <div class="whatsapp-timestamp">Today, 10:30 AM</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Receipt Image</label>
                        <div id="whatsappImagePreview" class="text-center">
                            <p class="text-muted">Receipt image will appear here</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="sendWhatsAppMessage">
                        <i class="fab fa-whatsapp me-2"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date for all date fields
            setCurrentDate();
            
            // Load data from localStorage
            loadData();
            
            // Initialize navigation
            initNavigation();
            
            // Initialize forms
            initForms();
            
            // Initialize event listeners
            initEventListeners();
            
            // Update summary section
            updateSummarySection();
            
            // Initialize financial chart
            initFinancialChart();
            
            // Initialize pending chanda
            updatePendingChandaList();
        });
        
        // Set current date for all date fields
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
        }
        
        // Initialize navigation
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Update summary section if summary tab is clicked
                    if (sectionId === 'summary') {
                        updateSummarySection();
                        updateFinancialChart();
                    }
                    
                    // Update pending chanda if pending chanda tab is clicked
                    if (sectionId === 'pending-chanda') {
                        updatePendingChandaList();
                    }
                });
            });
        }
        
        // Initialize forms
        function initForms() {
            // Masjid Info Form
            const masjidInfoForm = document.getElementById('masjidInfoForm');
            masjidInfoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveMasjidInfo();
            });
            
            // Committee Member Form
            const committeeMemberForm = document.getElementById('committeeMemberForm');
            committeeMemberForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addCommitteeMember();
            });
            
            // Household Form
            const householdForm = document.getElementById('householdForm');
            householdForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addHousehold();
            });
            
            // Link Household Form
            const linkHouseholdForm = document.getElementById('linkHouseholdForm');
            linkHouseholdForm.addEventListener('submit', function(e) {
                e.preventDefault();
                linkHouseholdToMember();
            });
            
            // Donation Form
            const donationForm = document.getElementById('donationForm');
            donationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addDonation();
            });
            
            // Construction Donation Form
            const constructionDonationForm = document.getElementById('constructionDonationForm');
            constructionDonationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addConstructionDonation();
            });
            
            // Construction Expense Form
            const constructionExpenseForm = document.getElementById('constructionExpenseForm');
            constructionExpenseForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addConstructionExpense();
            });
            
            // Announcement Form
            const announcementForm = document.getElementById('announcementForm');
            announcementForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addAnnouncement();
            });
            
            // Chanda Form
            const chandaForm = document.getElementById('chandaForm');
            chandaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addChandaCollection();
            });
            
            // Financial Report Form
            const financialReportForm = document.getElementById('financialReportForm');
            financialReportForm.addEventListener('submit', function(e) {
                e.preventDefault();
                generateFinancialReport();
            });
        }
        
        // Initialize event listeners
        function initEventListeners() {
            // Logo upload
            const logoUpload = document.getElementById('logoUpload');
            logoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" alt="Masjid Logo">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Reset Masjid Info
            document.getElementById('resetMasjidInfo').addEventListener('click', function() {
                document.getElementById('masjidInfoForm').reset();
                document.getElementById('logoPreview').innerHTML = '<i class="fas fa-mosque fa-3x text-muted"></i>';
            });
            
            // Generate Committee Report
            document.getElementById('generateCommitteeReport').addEventListener('click', function() {
                generateCommitteeReport();
            });
            
            // Generate Donation Reports
            document.querySelectorAll('.generate-donation-report').forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    generateDonationReport(type);
                });
            });
            
            // Generate Construction Report
            document.getElementById('generateConstructionReport').addEventListener('click', function() {
                generateConstructionReport();
            });
            
            // Generate Chanda Reports
            document.querySelectorAll('.generate-chanda-report').forEach(button => {
                button.addEventListener('click', function() {
                    const purpose = this.getAttribute('data-purpose');
                    generateChandaReport(purpose);
                });
            });
            
            // Download PDF button
            document.getElementById('downloadPdf').addEventListener('click', function() {
                const content = document.getElementById('previewContent');
                downloadPdf(content);
            });
            
            // Report date range change
            document.getElementById('reportDateRange').addEventListener('change', function() {
                const customDateRange = document.getElementById('customDateRange');
                if (this.value === 'custom') {
                    customDateRange.style.display = 'flex';
                } else {
                    customDateRange.style.display = 'none';
                }
            });
            
            // Report attachments
            document.getElementById('reportAttachments').addEventListener('change', function(e) {
                const files = e.target.files;
                const attachmentList = document.getElementById('attachmentList');
                attachmentList.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const attachmentItem = document.createElement('div');
                    attachmentItem.className = 'file-attachment-item';
                    attachmentItem.innerHTML = `
                        <i class="fas fa-file"></i>
                        <span class="file-attachment-name">${file.name}</span>
                        <button type="button" class="file-attachment-remove" data-index="${i}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    attachmentList.appendChild(attachmentItem);
                }
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.file-attachment-remove').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const dt = new DataTransfer();
                        const input = document.getElementById('reportAttachments');
                        
                        for (let i = 0; i < input.files.length; i++) {
                            if (i !== index) {
                                dt.items.add(input.files[i]);
                            }
                        }
                        
                        input.files = dt.files;
                        this.parentElement.remove();
                    });
                });
            });
            
            // Quick report buttons
            document.getElementById('generateMonthlyReport').addEventListener('click', function() {
                generateQuickReport('monthly');
            });
            
            document.getElementById('generateQuarterlyReport').addEventListener('click', function() {
                generateQuickReport('quarterly');
            });
            
            document.getElementById('generateAnnualReport').addEventListener('click', function() {
                generateQuickReport('annual');
            });
            
            document.getElementById('generateCustomReport').addEventListener('click', function() {
                document.getElementById('reportDateRange').value = 'custom';
                document.getElementById('customDateRange').style.display = 'flex';
                document.getElementById('financialReportForm').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Announcement image upload
            document.getElementById('announcementImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('announcementImagePreview');
                        preview.innerHTML = `<img src="${e.target.result}" class="announcement-image-preview" alt="Announcement Image">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Generate receipt preview
            document.getElementById('generateReceiptPreview').addEventListener('click', function() {
                generateChandaReceipt();
            });
            
            // Download receipt image
            document.getElementById('downloadReceiptImage').addEventListener('click', function() {
                downloadReceiptAsImage();
            });
            
            // Share receipt on WhatsApp
            document.getElementById('shareReceiptWhatsApp').addEventListener('click', function() {
                shareReceiptOnWhatsApp();
            });
            
            // Refresh pending chanda
            document.getElementById('refreshPendingChanda').addEventListener('click', function() {
                updatePendingChandaList();
                showToast('Pending chanda list refreshed', 'success');
            });
            
            // Send WhatsApp alerts
            document.getElementById('sendWhatsAppAlerts').addEventListener('click', function() {
                sendWhatsAppAlerts();
            });
            
            // Send WhatsApp message
            document.getElementById('sendWhatsAppMessage').addEventListener('click', function() {
                const phoneNumber = document.getElementById('whatsappNumberSelect').value;
                const message = document.getElementById('whatsappMessage').value;
                
                if (!phoneNumber || !message) {
                    showToast('Please select a phone number and enter a message', 'error');
                    return;
                }
                
                // Open WhatsApp with the message
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('whatsappModal'));
                modal.hide();
                
                showToast('WhatsApp opened with pre-filled message', 'success');
            });
            
            // Update WhatsApp message preview
            document.getElementById('whatsappMessage').addEventListener('input', function() {
                document.getElementById('whatsappPreviewText').textContent = this.value;
            });
        }
        
        // Load data from localStorage
        function loadData() {
            // Load masjid info
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            if (masjidInfo.name) document.getElementById('masjidName').value = masjidInfo.name;
            if (masjidInfo.address) document.getElementById('masjidAddress').value = masjidInfo.address;
            if (masjidInfo.logo) document.getElementById('logoPreview').innerHTML = `<img src="${masjidInfo.logo}" alt="Masjid Logo">`;
            
            // Load WhatsApp numbers
            if (masjidInfo.whatsappNumbers) {
                if (masjidInfo.whatsappNumbers[0]) document.getElementById('whatsappNumber1').value = masjidInfo.whatsappNumbers[0];
                if (masjidInfo.whatsappNumbers[1]) document.getElementById('whatsappNumber2').value = masjidInfo.whatsappNumbers[1];
                if (masjidInfo.whatsappNumbers[2]) document.getElementById('whatsappNumber3').value = masjidInfo.whatsappNumbers[2];
            }
            
            // Load committee members
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            updateCommitteeMembersTable(committeeMembers);
            updateCommitteeMemberSelects(committeeMembers);
            
            // Load households
            const households = JSON.parse(localStorage.getItem('households')) || [];
            updateHouseholdsTable(households);
            updateHouseholdSelects(households);
            
            // Load member-household links
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            updateMemberHouseholdLinksTable(memberHouseholdLinks);
            
            // Load donations
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            updateDonationsTable(donations);
            updateDonationSummary(donations);
            
            // Load construction donations
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            updateConstructionDonationsTable(constructionDonations);
            updateConstructionDonationsTotal(constructionDonations);
            
            // Load construction expenses
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            updateConstructionExpensesTable(constructionExpenses);
            updateConstructionExpensesTotal(constructionExpenses);
            updateConstructionBudgetSummary(constructionDonations, constructionExpenses);
            
            // Load announcements
            const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
            updateAnnouncementsTable(announcements);
            
            // Load chanda collections
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            updateChandaTable(chandaCollections);
            updateChandaSummary(chandaCollections);
        }
        
        // Update summary section
        function updateSummarySection() {
            // Get all financial data
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            
            // Calculate totals
            const jummaCollection = donations
                .filter(d => d.type === 'jumma')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const monthlyChanda = donations
                .filter(d => d.type === 'monthly')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const generalDonations = donations
                .filter(d => d.type === 'general')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const constructionDonationsTotal = constructionDonations
                .reduce((sum, d) => sum + d.amount, 0);
            
            const chandaCollectionsTotal = chandaCollections
                .reduce((sum, c) => sum + c.amount, 0);
            
            const memberHouseholdDonations = memberHouseholdLinks
                .reduce((sum, link) => {
                    return sum + link.donations.reduce((donationSum, donation) => donationSum + donation.amount, 0);
                }, 0);
            
            const totalIncome = jummaCollection + monthlyChanda + generalDonations + constructionDonationsTotal + chandaCollectionsTotal + memberHouseholdDonations;
            
            const totalExpenses = constructionExpenses
                .reduce((sum, e) => sum + e.amount, 0);
            
            const totalBalance = totalIncome - totalExpenses;
            
            // Update summary display
            document.getElementById('summaryJummaCollection').textContent = jummaCollection.toFixed(2);
            document.getElementById('summaryMonthlyChanda').textContent = monthlyChanda.toFixed(2);
            document.getElementById('summaryGeneralDonations').textContent = generalDonations.toFixed(2);
            document.getElementById('summaryConstructionDonations').textContent = constructionDonationsTotal.toFixed(2);
            document.getElementById('summaryChandaCollections').textContent = chandaCollectionsTotal.toFixed(2);
            document.getElementById('summaryTotalIncome').textContent = totalIncome.toFixed(2);
            document.getElementById('summaryConstructionExpenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('summaryTotalExpenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('summaryTotalBalance').textContent = totalBalance.toFixed(2);
            
            // Update balance color based on value
            const balanceElement = document.getElementById('summaryTotalBalance').parentElement;
            if (totalBalance < 0) {
                balanceElement.className = 'summary-item balance negative';
            } else {
                balanceElement.className = 'summary-item balance positive';
            }
        }
        
        // Initialize financial chart
        function initFinancialChart() {
            const ctx = document.getElementById('financialChart').getContext('2d');
            
            // Get data for chart
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            
            const jummaCollection = donations
                .filter(d => d.type === 'jumma')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const monthlyChanda = donations
                .filter(d => d.type === 'monthly')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const generalDonations = donations
                .filter(d => d.type === 'general')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const constructionDonationsTotal = constructionDonations
                .reduce((sum, d) => sum + d.amount, 0);
            
            const chandaCollectionsTotal = chandaCollections
                .reduce((sum, c) => sum + c.amount, 0);
            
            const totalExpenses = constructionExpenses
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Create chart
            window.financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['जुम्मा', 'मासिक चंदा', 'सामान्य दान', 'निर्माण दान', 'चंद', 'खर्च'],
                    datasets: [{
                        label: 'राशि (₹)',
                        data: [
                            jummaCollection,
                            monthlyChanda,
                            generalDonations,
                            constructionDonationsTotal,
                            chandaCollectionsTotal,
                            -totalExpenses
                        ],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'वित्तीय अवलोकन'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Update financial chart
        function updateFinancialChart() {
            if (!window.financialChart) return;
            
            // Get data for chart
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            
            const jummaCollection = donations
                .filter(d => d.type === 'jumma')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const monthlyChanda = donations
                .filter(d => d.type === 'monthly')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const generalDonations = donations
                .filter(d => d.type === 'general')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const constructionDonationsTotal = constructionDonations
                .reduce((sum, d) => sum + d.amount, 0);
            
            const chandaCollectionsTotal = chandaCollections
                .reduce((sum, c) => sum + c.amount, 0);
            
            const totalExpenses = constructionExpenses
                .reduce((sum, e) => sum + e.amount, 0);
            
            // Update chart data
            window.financialChart.data.datasets[0].data = [
                jummaCollection,
                monthlyChanda,
                generalDonations,
                constructionDonationsTotal,
                chandaCollectionsTotal,
                -totalExpenses
            ];
            
            window.financialChart.update();
        }
        
        // Generate quick report
        function generateQuickReport(type) {
            let startDate, endDate, title;
            const today = new Date();
            
            switch (type) {
                case 'monthly':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    title = 'मासिक वित्तीय रिपोर्ट';
                    break;
                case 'quarterly':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    endDate = new Date(today.getFullYear(), (currentQuarter + 1) * 3, 0);
                    title = 'त्रैमासिक वित्तीय रिपोर्ट';
                    break;
                case 'annual':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    title = 'वार्षिक वित्तीय रिपोर्ट';
                    break;
                default:
                    return;
            }
            
            // Format dates
            const formattedStartDate = formatDateForInput(startDate);
            const formattedEndDate = formatDateForInput(endDate);
            
            // Set form values
            document.getElementById('reportDateRange').value = 'custom';
            document.getElementById('customDateRange').style.display = 'flex';
            document.getElementById('reportStartDate').value = formattedStartDate;
            document.getElementById('reportEndDate').value = formattedEndDate;
            
            // Scroll to form
            document.getElementById('financialReportForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Format date for input
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Generate financial report
        function generateFinancialReport() {
            const dateRange = document.getElementById('reportDateRange').value;
            let startDate, endDate;
            
            if (dateRange === 'custom') {
                startDate = new Date(document.getElementById('reportStartDate').value);
                endDate = new Date(document.getElementById('reportEndDate').value);
            } else {
                const today = new Date();
                
                switch (dateRange) {
                    case 'currentMonth':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        break;
                    case 'lastMonth':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                        break;
                    case 'currentYear':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        endDate = new Date(today.getFullYear(), 11, 31);
                        break;
                    default: // all
                        startDate = new Date(2000, 0, 1); // Very old date to include all records
                        endDate = new Date();
                }
            }
            
            // Get included sections
            const includeDonations = document.getElementById('includeDonations').checked;
            const includeConstruction = document.getElementById('includeConstruction').checked;
            const includeChanda = document.getElementById('includeChanda').checked;
            
            // Get attachments
            const attachments = Array.from(document.getElementById('reportAttachments').files);
            
            // Get all financial data
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            
            // Filter data by date range
            const filteredDonations = donations.filter(d => {
                const donationDate = new Date(d.date);
                return donationDate >= startDate && donationDate <= endDate;
            });
            
            const filteredConstructionDonations = constructionDonations.filter(d => {
                const donationDate = new Date(d.date);
                return donationDate >= startDate && donationDate <= endDate;
            });
            
            const filteredConstructionExpenses = constructionExpenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            });
            
            const filteredChandaCollections = chandaCollections.filter(c => {
                const collectionDate = new Date(c.date);
                return collectionDate >= startDate && collectionDate <= endDate;
            });
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpenses = 0;
            
            const jummaCollection = filteredDonations
                .filter(d => d.type === 'jumma')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const monthlyChanda = filteredDonations
                .filter(d => d.type === 'monthly')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const generalDonations = filteredDonations
                .filter(d => d.type === 'general')
                .reduce((sum, d) => sum + d.amount, 0);
            
            const constructionDonationsTotal = filteredConstructionDonations
                .reduce((sum, d) => sum + d.amount, 0);
            
            const chandaCollectionsTotal = filteredChandaCollections
                .reduce((sum, c) => sum + c.amount, 0);
            
            const constructionExpensesTotal = filteredConstructionExpenses
                .reduce((sum, e) => sum + e.amount, 0);
            
            totalIncome = jummaCollection + monthlyChanda + generalDonations + constructionDonationsTotal + chandaCollectionsTotal;
            totalExpenses = constructionExpensesTotal;
            
            const totalBalance = totalIncome - totalExpenses;
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            // Generate report content
            let content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} वित्तीय रिपोर्ट</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>रिपोर्ट अवधि:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>जनरेट किया गया:</strong> ${formatDate(new Date())}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <h4 class="text-success">₹${totalIncome.toFixed(2)}</h4>
                            <p>कुल आय</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <h4 class="text-danger">₹${totalExpenses.toFixed(2)}</h4>
                            <p>कुल खर्च</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <h4 class="${totalBalance < 0 ? 'text-danger' : 'text-primary'}">₹${totalBalance.toFixed(2)}</h4>
                            <p>कुल बचत</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add income details if donations are included
            if (includeDonations) {
                content += `
                    <div class="mb-4">
                        <h5>दान / जुम्मा कलेक्शन</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>प्रकार</th>
                                    <th>राशि (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>जुम्मा कलेक्शन</td>
                                    <td>₹${jummaCollection.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>मासिक चंदा</td>
                                    <td>₹${monthlyChanda.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>सामान्य दान</td>
                                    <td>₹${generalDonations.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Add construction details if construction is included
            if (includeConstruction) {
                content += `
                    <div class="mb-4">
                        <h5>निर्माण बजट और खर्च</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>प्रकार</th>
                                    <th>राशि (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>निर्माण दान</td>
                                    <td>₹${constructionDonationsTotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td>निर्माण खर्च</td>
                                    <td>₹${constructionExpensesTotal.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Add chanda details if chanda is included
            if (includeChanda) {
                content += `
                    <div class="mb-4">
                        <h5>चंदा संग्रह</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>प्रकार</th>
                                    <th>राशि (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>चंदा संग्रह</td>
                                    <td>₹${chandaCollectionsTotal.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Add attachments section if there are any
            if (attachments.length > 0) {
                content += `
                    <div class="mb-4">
                        <h5>अटैचमेंट्स</h5>
                        <ul>
                `;
                
                attachments.forEach(attachment => {
                    content += `<li>${attachment.name}</li>`;
                });
                
                content += `
                        </ul>
                    </div>
                `;
            }
            
            content += `
                <div class="mb-4 text-center">
                    <div id="financialReportQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('financialReportQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Financial Report: ${formatDate(startDate)} - ${formatDate(endDate)}, Income: ₹${totalIncome.toFixed(2)}, Expenses: ₹${totalExpenses.toFixed(2)}, Balance: ₹${totalBalance.toFixed(2)}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Save masjid info
        function saveMasjidInfo() {
            const name = document.getElementById('masjidName').value;
            const address = document.getElementById('masjidAddress').value;
            const logoImg = document.querySelector('#logoPreview img');
            const logo = logoImg ? logoImg.src : null;
            
            // Get WhatsApp numbers
            const whatsappNumbers = [
                document.getElementById('whatsappNumber1').value,
                document.getElementById('whatsappNumber2').value,
                document.getElementById('whatsappNumber3').value
            ].filter(num => num.trim() !== '');
            
            const masjidInfo = { name, address, logo, whatsappNumbers };
            localStorage.setItem('masjidInfo', JSON.stringify(masjidInfo));
            
            // Update WhatsApp number select
            updateWhatsAppNumberSelect(whatsappNumbers);
            
            showToast('Masjid information saved successfully!', 'success');
        }
        
        // Update WhatsApp number select
        function updateWhatsAppNumberSelect(numbers) {
            const select = document.getElementById('whatsappNumberSelect');
            select.innerHTML = '<option value="">-- Select Number --</option>';
            
            numbers.forEach((number, index) => {
                const option = document.createElement('option');
                option.value = number.replace(/\D/g, ''); // Remove non-digits
                option.textContent = `Number ${index + 1}: ${number}`;
                select.appendChild(option);
            });
        }
        
        // Add committee member
        function addCommitteeMember() {
            const name = document.getElementById('memberName').value;
            const phone = document.getElementById('memberPhone').value;
            const email = document.getElementById('memberEmail').value;
            
            if (!name) {
                showToast('Please enter member name', 'error');
                return;
            }
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const newMember = {
                id: Date.now(),
                name,
                phone,
                email
            };
            
            committeeMembers.push(newMember);
            localStorage.setItem('committeeMembers', JSON.stringify(committeeMembers));
            
            updateCommitteeMembersTable(committeeMembers);
            updateCommitteeMemberSelects(committeeMembers);
            
            document.getElementById('committeeMemberForm').reset();
            showToast('Committee member added successfully!', 'success');
        }
        
        // Update committee members table
        function updateCommitteeMembersTable(members) {
            const tableBody = document.getElementById('committeeMembersTable');
            tableBody.innerHTML = '';
            
            members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.phone || '-'}</td>
                    <td>${member.email || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 edit-member" data-id="${member.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-member" data-id="${member.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-member').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editCommitteeMember(id);
                });
            });
            
            document.querySelectorAll('.delete-member').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteCommitteeMember(id);
                });
            });
        }
        
        // Edit committee member
        function editCommitteeMember(id) {
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const member = committeeMembers.find(m => m.id === id);
            
            if (member) {
                document.getElementById('memberName').value = member.name;
                document.getElementById('memberPhone').value = member.phone || '';
                document.getElementById('memberEmail').value = member.email || '';
                
                // Remove the member from the array
                const updatedMembers = committeeMembers.filter(m => m.id !== id);
                localStorage.setItem('committeeMembers', JSON.stringify(updatedMembers));
                
                updateCommitteeMembersTable(updatedMembers);
                updateCommitteeMemberSelects(updatedMembers);
                
                showToast('Member details loaded for editing', 'success');
            }
        }
        
        // Delete committee member
        function deleteCommitteeMember(id) {
            if (confirm('Are you sure you want to delete this member?')) {
                const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
                const updatedMembers = committeeMembers.filter(m => m.id !== id);
                localStorage.setItem('committeeMembers', JSON.stringify(updatedMembers));
                
                updateCommitteeMembersTable(updatedMembers);
                updateCommitteeMemberSelects(updatedMembers);
                
                showToast('Member deleted successfully', 'success');
            }
        }
        
        // Update committee member selects
        function updateCommitteeMemberSelects(members) {
            const selects = ['selectMember', 'responsibleMember', 'chandaCollector'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Clear options except the first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // Add member options
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    select.appendChild(option);
                });
                
                // Restore selected value if it still exists
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }
        
        // Add household
        function addHousehold() {
            const name = document.getElementById('householdName').value;
            const address = document.getElementById('householdAddress').value;
            const phone = document.getElementById('householdPhone').value;
            
            if (!name) {
                showToast('Please enter household name', 'error');
                return;
            }
            
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const newHousehold = {
                id: Date.now(),
                name,
                address,
                phone
            };
            
            households.push(newHousehold);
            localStorage.setItem('households', JSON.stringify(households));
            
            updateHouseholdsTable(households);
            updateHouseholdSelects(households);
            
            document.getElementById('householdForm').reset();
            showToast('Household added successfully!', 'success');
        }
        
        // Update households table
        function updateHouseholdsTable(households) {
            const tableBody = document.getElementById('householdsTable');
            tableBody.innerHTML = '';
            
            households.forEach(household => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${household.name}</td>
                    <td>${household.address || '-'}</td>
                    <td>${household.phone || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 edit-household" data-id="${household.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-household" data-id="${household.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-household').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editHousehold(id);
                });
            });
            
            document.querySelectorAll('.delete-household').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteHousehold(id);
                });
            });
        }
        
        // Edit household
        function editHousehold(id) {
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const household = households.find(h => h.id === id);
            
            if (household) {
                document.getElementById('householdName').value = household.name;
                document.getElementById('householdAddress').value = household.address || '';
                document.getElementById('householdPhone').value = household.phone || '';
                
                // Remove the household from the array
                const updatedHouseholds = households.filter(h => h.id !== id);
                localStorage.setItem('households', JSON.stringify(updatedHouseholds));
                
                updateHouseholdsTable(updatedHouseholds);
                updateHouseholdSelects(updatedHouseholds);
                
                showToast('Household details loaded for editing', 'success');
            }
        }
        
        // Delete household
        function deleteHousehold(id) {
            if (confirm('Are you sure you want to delete this household?')) {
                const households = JSON.parse(localStorage.getItem('households')) || [];
                const updatedHouseholds = households.filter(h => h.id !== id);
                localStorage.setItem('households', JSON.stringify(updatedHouseholds));
                
                updateHouseholdsTable(updatedHouseholds);
                updateHouseholdSelects(updatedHouseholds);
                
                showToast('Household deleted successfully', 'success');
            }
        }
        
        // Update household selects
        function updateHouseholdSelects(households) {
            const select = document.getElementById('selectHousehold');
            const currentValue = select.value;
            
            // Clear options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add household options
            households.forEach(household => {
                const option = document.createElement('option');
                option.value = household.id;
                option.textContent = household.name;
                select.appendChild(option);
            });
            
            // Restore selected value if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // Link household to member
        function linkHouseholdToMember() {
            const memberId = document.getElementById('selectMember').value;
            const householdId = document.getElementById('selectHousehold').value;
            
            if (!memberId || !householdId) {
                showToast('Please select both a member and a household', 'error');
                return;
            }
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            
            const member = committeeMembers.find(m => m.id == memberId);
            const household = households.find(h => h.id == householdId);
            
            // Check if household is already linked to another member
            const existingLink = memberHouseholdLinks.find(link => link.householdId == householdId);
            if (existingLink) {
                showToast('This household is already linked to another member', 'error');
                return;
            }
            
            const newLink = {
                id: Date.now(),
                memberId: parseInt(memberId),
                householdId: parseInt(householdId),
                donations: []
            };
            
            memberHouseholdLinks.push(newLink);
            localStorage.setItem('memberHouseholdLinks', JSON.stringify(memberHouseholdLinks));
            
            updateMemberHouseholdLinksTable(memberHouseholdLinks);
            
            document.getElementById('linkHouseholdForm').reset();
            showToast('Household linked to member successfully!', 'success');
        }
        
        // Update member-household links table
        function updateMemberHouseholdLinksTable(links) {
            const tableBody = document.getElementById('memberHouseholdLinksTable');
            tableBody.innerHTML = '';
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const households = JSON.parse(localStorage.getItem('households')) || [];
            
            links.forEach(link => {
                const member = committeeMembers.find(m => m.id === link.memberId);
                const household = households.find(h => h.id === link.householdId);
                
                if (member && household) {
                    const totalDonations = link.donations.reduce((sum, donation) => sum + donation.amount, 0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${member.name}</td>
                        <td>${household.name}</td>
                        <td>₹${totalDonations.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1 track-donation" data-id="${link.id}">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-link" data-id="${link.id}">
                                <i class="fas fa-unlink"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
            
            // Add event listeners
            document.querySelectorAll('.track-donation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    trackDonation(id);
                });
            });
            
            document.querySelectorAll('.delete-link').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteMemberHouseholdLink(id);
                });
            });
        }
        
        // Track donation for member-household link
        function trackDonation(linkId) {
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            const link = memberHouseholdLinks.find(l => l.id === linkId);
            
            if (!link) return;
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const households = JSON.parse(localStorage.getItem('households')) || [];
            
            const member = committeeMembers.find(m => m.id === link.memberId);
            const household = households.find(h => h.id === link.householdId);
            
            if (!member || !household) return;
            
            const amount = prompt(`Enter donation amount for ${household.name} (linked to ${member.name}):`);
            
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const donation = {
                    id: Date.now(),
                    amount: parseFloat(amount),
                    date: new Date().toISOString().split('T')[0]
                };
                
                link.donations.push(donation);
                localStorage.setItem('memberHouseholdLinks', JSON.stringify(memberHouseholdLinks));
                
                updateMemberHouseholdLinksTable(memberHouseholdLinks);
                updateSummarySection();
                
                showToast('Donation recorded successfully!', 'success');
            } else if (amount !== null) {
                showToast('Please enter a valid amount', 'error');
            }
        }
        
        // Delete member-household link
        function deleteMemberHouseholdLink(id) {
            if (confirm('Are you sure you want to delete this link?')) {
                const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
                const updatedLinks = memberHouseholdLinks.filter(link => link.id !== id);
                localStorage.setItem('memberHouseholdLinks', JSON.stringify(updatedLinks));
                
                updateMemberHouseholdLinksTable(updatedLinks);
                
                showToast('Link deleted successfully', 'success');
            }
        }
        
        // Add donation
        function addDonation() {
            const donorName = document.getElementById('donorName').value;
            const amount = parseFloat(document.getElementById('donationAmount').value);
            const date = document.getElementById('donationDate').value;
            const type = document.getElementById('donationType').value;
            const memberId = document.getElementById('responsibleMember').value;
            const receiptFile = document.getElementById('donationReceipt').files[0];
            
            if (!donorName || !amount || amount <= 0 || !date) {
                showToast('Please fill all required fields with valid values', 'error');
                return;
            }
            
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            
            // Handle receipt file
            let receiptData = null;
            if (receiptFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    receiptData = e.target.result;
                    
                    const newDonation = {
                        id: Date.now(),
                        donorName,
                        amount,
                        date,
                        type,
                        memberId: memberId ? parseInt(memberId) : null,
                        receipt: receiptData
                    };
                    
                    donations.push(newDonation);
                    localStorage.setItem('donations', JSON.stringify(donations));
                    
                    updateDonationsTable(donations);
                    updateDonationSummary(donations);
                    updateSummarySection();
                    
                    document.getElementById('donationForm').reset();
                    setCurrentDate();
                    showToast('Donation added successfully!', 'success');
                };
                reader.readAsDataURL(receiptFile);
            } else {
                const newDonation = {
                    id: Date.now(),
                    donorName,
                    amount,
                    date,
                    type,
                    memberId: memberId ? parseInt(memberId) : null,
                    receipt: null
                };
                
                donations.push(newDonation);
                localStorage.setItem('donations', JSON.stringify(donations));
                
                updateDonationsTable(donations);
                updateDonationSummary(donations);
                updateSummarySection();
                
                document.getElementById('donationForm').reset();
                setCurrentDate();
                showToast('Donation added successfully!', 'success');
            }
        }
        
        // Update donations table
        function updateDonationsTable(donations) {
            const tableBody = document.getElementById('recentDonationsTable');
            tableBody.innerHTML = '';
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            
            // Sort donations by date (newest first)
            const sortedDonations = [...donations].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only the 10 most recent donations
            const recentDonations = sortedDonations.slice(0, 10);
            
            recentDonations.forEach(donation => {
                const member = donation.memberId ? committeeMembers.find(m => m.id === donation.memberId) : null;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(donation.date)}</td>
                    <td>${donation.donorName}</td>
                    <td>₹${donation.amount.toFixed(2)}</td>
                    <td>${getDonationTypeLabel(donation.type)}</td>
                    <td>${member ? member.name : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 view-donation" data-id="${donation.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-donation" data-id="${donation.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-donation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewDonation(id);
                });
            });
            
            document.querySelectorAll('.delete-donation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteDonation(id);
                });
            });
        }
        
        // Update donation summary
        function updateDonationSummary(donations) {
            const summary = {
                general: { total: 0, count: 0 },
                monthly: { total: 0, count: 0 },
                jumma: { total: 0, count: 0 }
            };
            
            donations.forEach(donation => {
                summary[donation.type].total += donation.amount;
                summary[donation.type].count += 1;
            });
            
            const tableBody = document.getElementById('donationSummaryTable');
            const rows = tableBody.querySelectorAll('tr');
            
            // Update individual rows
            rows[0].cells[1].textContent = summary.general.total.toFixed(2);
            rows[0].cells[2].textContent = summary.general.count;
            
            rows[1].cells[1].textContent = summary.monthly.total.toFixed(2);
            rows[1].cells[2].textContent = summary.monthly.count;
            
            rows[2].cells[1].textContent = summary.jumma.total.toFixed(2);
            rows[2].cells[2].textContent = summary.jumma.count;
            
            // Update total row
            const totalAmount = summary.general.total + summary.monthly.total + summary.jumma.total;
            const totalCount = summary.general.count + summary.monthly.count + summary.jumma.count;
            
            rows[3].cells[1].textContent = totalAmount.toFixed(2);
            rows[3].cells[2].textContent = totalCount;
        }
        
        // Get donation type label
        function getDonationTypeLabel(type) {
            const labels = {
                general: 'General',
                monthly: 'Monthly Chanda',
                jumma: 'Jumma Collection'
            };
            
            return labels[type] || type;
        }
        
        // View donation
        function viewDonation(id) {
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            const donation = donations.find(d => d.id === id);
            
            if (!donation) return;
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const member = donation.memberId ? committeeMembers.find(m => m.id === donation.memberId) : null;
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            const content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} Donation Receipt</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <p><strong>Date:</strong> ${formatDate(donation.date)}</p>
                    <p><strong>Donor Name:</strong> ${donation.donorName}</p>
                    <p><strong>Amount:</strong> ₹${donation.amount.toFixed(2)}</p>
                    <p><strong>Donation Type:</strong> ${getDonationTypeLabel(donation.type)}</p>
                    <p><strong>Responsible Member:</strong> ${member ? member.name : '-'}</p>
                </div>
                
                ${donation.receipt ? `
                    <div class="mb-4 text-center">
                        <p><strong>Receipt:</strong></p>
                        <img src="${donation.receipt}" alt="Receipt" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; padding: 5px;">
                    </div>
                ` : ''}
                
                <div class="mb-4 text-center">
                    <div id="donationQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('donationQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Donation ID: ${donation.id}, Amount: ₹${donation.amount.toFixed(2)}, Date: ${donation.date}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Delete donation
        function deleteDonation(id) {
            if (confirm('Are you sure you want to delete this donation?')) {
                const donations = JSON.parse(localStorage.getItem('donations')) || [];
                const updatedDonations = donations.filter(d => d.id !== id);
                localStorage.setItem('donations', JSON.stringify(updatedDonations));
                
                updateDonationsTable(updatedDonations);
                updateDonationSummary(updatedDonations);
                updateSummarySection();
                
                showToast('Donation deleted successfully', 'success');
            }
        }
        
        // Add construction donation
        function addConstructionDonation() {
            const donor = document.getElementById('constructionDonor').value;
            const amount = parseFloat(document.getElementById('constructionDonationAmount').value);
            const date = document.getElementById('constructionDonationDate').value;
            const receiptFile = document.getElementById('constructionDonationReceipt').files[0];
            
            if (!donor || !amount || amount <= 0 || !date) {
                showToast('Please fill all required fields with valid values', 'error');
                return;
            }
            
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            
            // Handle receipt file
            let receiptData = null;
            if (receiptFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    receiptData = e.target.result;
                    
                    const newDonation = {
                        id: Date.now(),
                        donor,
                        amount,
                        date,
                        receipt: receiptData
                    };
                    
                    constructionDonations.push(newDonation);
                    localStorage.setItem('constructionDonations', JSON.stringify(constructionDonations));
                    
                    updateConstructionDonationsTable(constructionDonations);
                    updateConstructionDonationsTotal(constructionDonations);
                    
                    const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
                    updateConstructionBudgetSummary(constructionDonations, constructionExpenses);
                    updateSummarySection();
                    
                    document.getElementById('constructionDonationForm').reset();
                    setCurrentDate();
                    showToast('Construction donation added successfully!', 'success');
                };
                reader.readAsDataURL(receiptFile);
            } else {
                const newDonation = {
                    id: Date.now(),
                    donor,
                    amount,
                    date,
                    receipt: null
                };
                
                constructionDonations.push(newDonation);
                localStorage.setItem('constructionDonations', JSON.stringify(constructionDonations));
                
                updateConstructionDonationsTable(constructionDonations);
                updateConstructionDonationsTotal(constructionDonations);
                
                const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
                updateConstructionBudgetSummary(constructionDonations, constructionExpenses);
                updateSummarySection();
                
                document.getElementById('constructionDonationForm').reset();
                setCurrentDate();
                showToast('Construction donation added successfully!', 'success');
            }
        }
        
        // Update construction donations table
        function updateConstructionDonationsTable(donations) {
            const tableBody = document.getElementById('constructionDonationsTable');
            tableBody.innerHTML = '';
            
            // Sort donations by date (newest first)
            const sortedDonations = [...donations].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedDonations.forEach(donation => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(donation.date)}</td>
                    <td>${donation.donor}</td>
                    <td>₹${donation.amount.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 view-construction-donation" data-id="${donation.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-construction-donation" data-id="${donation.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-construction-donation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewConstructionDonation(id);
                });
            });
            
            document.querySelectorAll('.delete-construction-donation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteConstructionDonation(id);
                });
            });
        }
        
        // Update construction donations total
        function updateConstructionDonationsTotal(donations) {
            const total = donations.reduce((sum, donation) => sum + donation.amount, 0);
            document.getElementById('totalConstructionDonations').textContent = total.toFixed(2);
            document.getElementById('budgetTotalDonations').textContent = total.toFixed(2);
        }
        
        // View construction donation
        function viewConstructionDonation(id) {
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            const donation = constructionDonations.find(d => d.id === id);
            
            if (!donation) return;
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            const content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} Construction Donation Receipt</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <p><strong>Date:</strong> ${formatDate(donation.date)}</p>
                    <p><strong>Donor:</strong> ${donation.donor}</p>
                    <p><strong>Amount:</strong> ₹${donation.amount.toFixed(2)}</p>
                </div>
                
                ${donation.receipt ? `
                    <div class="mb-4 text-center">
                        <p><strong>Receipt:</strong></p>
                        <img src="${donation.receipt}" alt="Receipt" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; padding: 5px;">
                    </div>
                ` : ''}
                
                <div class="mb-4 text-center">
                    <div id="constructionDonationQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('constructionDonationQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Construction Donation ID: ${donation.id}, Amount: ₹${donation.amount.toFixed(2)}, Date: ${donation.date}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Delete construction donation
        function deleteConstructionDonation(id) {
            if (confirm('Are you sure you want to delete this construction donation?')) {
                const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
                const updatedDonations = constructionDonations.filter(d => d.id !== id);
                localStorage.setItem('constructionDonations', JSON.stringify(updatedDonations));
                
                updateConstructionDonationsTable(updatedDonations);
                updateConstructionDonationsTotal(updatedDonations);
                
                const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
                updateConstructionBudgetSummary(updatedDonations, constructionExpenses);
                updateSummarySection();
                
                showToast('Construction donation deleted successfully', 'success');
            }
        }
        
        // Add construction expense
        function addConstructionExpense() {
            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const billFile = document.getElementById('expenseBill').files[0];
            
            if (!description || !amount || amount <= 0 || !date) {
                showToast('Please fill all required fields with valid values', 'error');
                return;
            }
            
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            
            // Handle bill file
            let billData = null;
            if (billFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    billData = e.target.result;
                    
                    const newExpense = {
                        id: Date.now(),
                        description,
                        amount,
                        date,
                        bill: billData
                    };
                    
                    constructionExpenses.push(newExpense);
                    localStorage.setItem('constructionExpenses', JSON.stringify(constructionExpenses));
                    
                    updateConstructionExpensesTable(constructionExpenses);
                    updateConstructionExpensesTotal(constructionExpenses);
                    
                    const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
                    updateConstructionBudgetSummary(constructionDonations, constructionExpenses);
                    updateSummarySection();
                    
                    document.getElementById('constructionExpenseForm').reset();
                    setCurrentDate();
                    showToast('Construction expense added successfully!', 'success');
                };
                reader.readAsDataURL(billFile);
            } else {
                const newExpense = {
                    id: Date.now(),
                    description,
                    amount,
                    date,
                    bill: null
                };
                
                constructionExpenses.push(newExpense);
                localStorage.setItem('constructionExpenses', JSON.stringify(constructionExpenses));
                
                updateConstructionExpensesTable(constructionExpenses);
                updateConstructionExpensesTotal(constructionExpenses);
                
                const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
                updateConstructionBudgetSummary(constructionDonations, constructionExpenses);
                updateSummarySection();
                
                document.getElementById('constructionExpenseForm').reset();
                setCurrentDate();
                showToast('Construction expense added successfully!', 'success');
            }
        }
        
        // Update construction expenses table
        function updateConstructionExpensesTable(expenses) {
            const tableBody = document.getElementById('constructionExpensesTable');
            tableBody.innerHTML = '';
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td>${expense.description}</td>
                    <td>₹${expense.amount.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 view-construction-expense" data-id="${expense.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-construction-expense" data-id="${expense.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-construction-expense').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewConstructionExpense(id);
                });
            });
            
            document.querySelectorAll('.delete-construction-expense').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteConstructionExpense(id);
                });
            });
        }
        
        // Update construction expenses total
        function updateConstructionExpensesTotal(expenses) {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalConstructionExpenses').textContent = total.toFixed(2);
            document.getElementById('budgetTotalExpenses').textContent = total.toFixed(2);
        }
        
        // Update construction budget summary
        function updateConstructionBudgetSummary(donations, expenses) {
            const totalDonations = donations.reduce((sum, donation) => sum + donation.amount, 0);
            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = totalDonations - totalExpenses;
            
            document.getElementById('budgetTotalDonations').textContent = totalDonations.toFixed(2);
            document.getElementById('budgetTotalExpenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('budgetRemaining').textContent = remaining.toFixed(2);
            
            // Update color based on remaining budget
            const remainingElement = document.getElementById('budgetRemaining');
            if (remaining < 0) {
                remainingElement.className = 'text-danger';
            } else if (remaining < totalDonations * 0.2) {
                remainingElement.className = 'text-warning';
            } else {
                remainingElement.className = 'text-primary';
            }
        }
        
        // View construction expense
        function viewConstructionExpense(id) {
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            const expense = constructionExpenses.find(e => e.id === id);
            
            if (!expense) return;
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            const content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} Construction Expense Record</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <p><strong>Date:</strong> ${formatDate(expense.date)}</p>
                    <p><strong>Description:</strong> ${expense.description}</p>
                    <p><strong>Amount:</strong> ₹${expense.amount.toFixed(2)}</p>
                </div>
                
                ${expense.bill ? `
                    <div class="mb-4 text-center">
                        <p><strong>Bill:</strong></p>
                        <img src="${expense.bill}" alt="Bill" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; padding: 5px;">
                    </div>
                ` : ''}
                
                <div class="mb-4 text-center">
                    <div id="constructionExpenseQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('constructionExpenseQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Construction Expense ID: ${expense.id}, Amount: ₹${expense.amount.toFixed(2)}, Date: ${expense.date}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Delete construction expense
        function deleteConstructionExpense(id) {
            if (confirm('Are you sure you want to delete this construction expense?')) {
                const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
                const updatedExpenses = constructionExpenses.filter(e => e.id !== id);
                localStorage.setItem('constructionExpenses', JSON.stringify(updatedExpenses));
                
                updateConstructionExpensesTable(updatedExpenses);
                updateConstructionExpensesTotal(updatedExpenses);
                
                const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
                updateConstructionBudgetSummary(constructionDonations, updatedExpenses);
                updateSummarySection();
                
                showToast('Construction expense deleted successfully', 'success');
            }
        }
        
        // Add announcement
        function addAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const date = document.getElementById('announcementDate').value;
            const priority = document.getElementById('announcementPriority').value;
            const imageFile = document.getElementById('announcementImage').files[0];
            
            if (!title || !content || !date) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
            
            // Handle image file
            let imageData = null;
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    
                    const newAnnouncement = {
                        id: Date.now(),
                        title,
                        content,
                        date,
                        priority,
                        image: imageData
                    };
                    
                    announcements.push(newAnnouncement);
                    localStorage.setItem('announcements', JSON.stringify(announcements));
                    
                    updateAnnouncementsTable(announcements);
                    
                    document.getElementById('announcementForm').reset();
                    document.getElementById('announcementImagePreview').innerHTML = '';
                    setCurrentDate();
                    showToast('Announcement created successfully!', 'success');
                };
                reader.readAsDataURL(imageFile);
            } else {
                const newAnnouncement = {
                    id: Date.now(),
                    title,
                    content,
                    date,
                    priority,
                    image: null
                };
                
                announcements.push(newAnnouncement);
                localStorage.setItem('announcements', JSON.stringify(announcements));
                
                updateAnnouncementsTable(announcements);
                
                document.getElementById('announcementForm').reset();
                setCurrentDate();
                showToast('Announcement created successfully!', 'success');
            }
        }
        
        // Update announcements table
        function updateAnnouncementsTable(announcements) {
            const tableBody = document.getElementById('announcementsTable');
            tableBody.innerHTML = '';
            
            // Sort announcements by date (newest first)
            const sortedAnnouncements = [...announcements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAnnouncements.forEach(announcement => {
                const priorityClass = {
                    low: 'bg-success',
                    medium: 'bg-warning',
                    high: 'bg-danger'
                };
                
                const priorityLabel = {
                    low: 'Low',
                    medium: 'Medium',
                    high: 'High'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(announcement.date)}</td>
                    <td>${announcement.title}</td>
                    <td><span class="badge ${priorityClass[announcement.priority]}">${priorityLabel[announcement.priority]}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 view-announcement" data-id="${announcement.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-announcement" data-id="${announcement.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-announcement').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewAnnouncement(id);
                });
            });
            
            document.querySelectorAll('.delete-announcement').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteAnnouncement(id);
                });
            });
        }
        
        // View announcement
        function viewAnnouncement(id) {
            const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
            const announcement = announcements.find(a => a.id === id);
            
            if (!announcement) return;
            
            const priorityClass = {
                low: 'text-success',
                medium: 'text-warning',
                high: 'text-danger'
            };
            
            const priorityLabel = {
                low: 'Low',
                medium: 'Medium',
                high: 'High'
            };
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            const preview = document.getElementById('announcementPreview');
            preview.innerHTML = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} ${announcement.title}</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-3">
                    <p><strong>Date:</strong> ${formatDate(announcement.date)}</p>
                    <p><strong>Priority:</strong> <span class="${priorityClass[announcement.priority]}">${priorityLabel[announcement.priority]}</span></p>
                </div>
                
                ${announcement.image ? `
                    <div class="mb-4 text-center">
                        <img src="${announcement.image}" alt="Announcement Image" class="img-fluid" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; padding: 5px;">
                    </div>
                ` : ''}
                
                <div class="mb-4">
                    <p>${announcement.content.replace(/\n/g, '<br>')}</p>
                </div>
                
                <div class="text-end">
                    <button class="btn btn-primary generate-announcement-pdf" data-id="${announcement.id}">
                        <i class="fas fa-file-pdf me-2"></i> Generate PDF
                    </button>
                </div>
            `;
            
            // Add event listener for PDF generation
            document.querySelector('.generate-announcement-pdf').addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                generateAnnouncementPDF(id);
            });
        }
        
        // Delete announcement
        function deleteAnnouncement(id) {
            if (confirm('Are you sure you want to delete this announcement?')) {
                const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
                const updatedAnnouncements = announcements.filter(a => a.id !== id);
                localStorage.setItem('announcements', JSON.stringify(updatedAnnouncements));
                
                updateAnnouncementsTable(updatedAnnouncements);
                
                // Clear preview if the deleted announcement was being viewed
                document.getElementById('announcementPreview').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>Select an announcement to preview</p>
                    </div>
                `;
                
                showToast('Announcement deleted successfully', 'success');
            }
        }
        
        // Add chanda collection
        function addChandaCollection() {
            const donor = document.getElementById('chandaDonor').value;
            const amount = parseFloat(document.getElementById('chandaAmount').value);
            const date = document.getElementById('chandaDate').value;
            const collectorId = document.getElementById('chandaCollector').value;
            const purpose = document.getElementById('chandaPurpose').value;
            const notes = document.getElementById('chandaNotes').value;
            
            if (!donor || !amount || amount <= 0 || !date || !collectorId) {
                showToast('Please fill all required fields with valid values', 'error');
                return;
            }
            
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            const newCollection = {
                id: Date.now(),
                donor,
                amount,
                date,
                collectorId: parseInt(collectorId),
                purpose,
                notes
            };
            
            chandaCollections.push(newCollection);
            localStorage.setItem('chandaCollections', JSON.stringify(chandaCollections));
            
            updateChandaTable(chandaCollections);
            updateChandaSummary(chandaCollections);
            updateSummarySection();
            
            document.getElementById('chandaForm').reset();
            setCurrentDate();
            showToast('Chanda collection added successfully!', 'success');
        }
        
        // Update chanda table
        function updateChandaTable(collections) {
            const tableBody = document.getElementById('recentChandaTable');
            tableBody.innerHTML = '';
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            
            // Sort collections by date (newest first)
            const sortedCollections = [...collections].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only the 10 most recent collections
            const recentCollections = sortedCollections.slice(0, 10);
            
            recentCollections.forEach(collection => {
                const collector = committeeMembers.find(m => m.id === collection.collectorId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(collection.date)}</td>
                    <td>${collection.donor}</td>
                    <td>₹${collection.amount.toFixed(2)}</td>
                    <td>${getChandaPurposeLabel(collection.purpose)}</td>
                    <td>${collector ? collector.name : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1 view-chanda" data-id="${collection.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-chanda" data-id="${collection.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-chanda').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewChandaCollection(id);
                });
            });
            
            document.querySelectorAll('.delete-chanda').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteChandaCollection(id);
                });
            });
        }
        
        // Update chanda summary
        function updateChandaSummary(collections) {
            const summary = {
                general: { total: 0, count: 0 },
                maintenance: { total: 0, count: 0 },
                education: { total: 0, count: 0 },
                charity: { total: 0, count: 0 },
                other: { total: 0, count: 0 }
            };
            
            collections.forEach(collection => {
                summary[collection.purpose].total += collection.amount;
                summary[collection.purpose].count += 1;
            });
            
            const tableBody = document.getElementById('chandaSummaryTable');
            const rows = tableBody.querySelectorAll('tr');
            
            // Update individual rows
            rows[0].cells[1].textContent = summary.general.total.toFixed(2);
            rows[0].cells[2].textContent = summary.general.count;
            
            rows[1].cells[1].textContent = summary.maintenance.total.toFixed(2);
            rows[1].cells[2].textContent = summary.maintenance.count;
            
            rows[2].cells[1].textContent = summary.education.total.toFixed(2);
            rows[2].cells[2].textContent = summary.education.count;
            
            rows[3].cells[1].textContent = summary.charity.total.toFixed(2);
            rows[3].cells[2].textContent = summary.charity.count;
            
            rows[4].cells[1].textContent = summary.other.total.toFixed(2);
            rows[4].cells[2].textContent = summary.other.count;
            
            // Update total row
            const totalAmount = Object.values(summary).reduce((sum, item) => sum + item.total, 0);
            const totalCount = Object.values(summary).reduce((sum, item) => sum + item.count, 0);
            
            rows[5].cells[1].textContent = totalAmount.toFixed(2);
            rows[5].cells[2].textContent = totalCount;
        }
        
        // Get chanda purpose label
        function getChandaPurposeLabel(purpose) {
            const labels = {
                general: 'General',
                maintenance: 'Masjid Maintenance',
                education: 'Islamic Education',
                charity: 'Charity',
                other: 'Other'
            };
            
            return labels[purpose] || purpose;
        }
        
        // Generate chanda receipt
        function generateChandaReceipt() {
            const donor = document.getElementById('chandaDonor').value;
            const amount = parseFloat(document.getElementById('chandaAmount').value);
            const date = document.getElementById('chandaDate').value;
            const collectorId = document.getElementById('chandaCollector').value;
            const purpose = document.getElementById('chandaPurpose').value;
            const notes = document.getElementById('chandaNotes').value;
            
            if (!donor || !amount || !date || !collectorId) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const collector = committeeMembers.find(m => m.id == collectorId);
            
            // Get masjid info
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            // Update receipt details
            document.getElementById('receiptNumber').textContent = 'RCPT-' + Date.now();
            document.getElementById('receiptDate').textContent = formatDate(date);
            document.getElementById('receiptDonorName').textContent = donor;
            document.getElementById('receiptDonorAddress').textContent = '-';
            document.getElementById('receiptDonorPhone').textContent = '-';
            document.getElementById('receiptPurpose').textContent = getChandaPurposeLabel(purpose);
            document.getElementById('receiptCollector').textContent = collector ? collector.name : '-';
            document.getElementById('receiptAmount').textContent = '₹' + amount.toFixed(2);
            document.getElementById('receiptAmountInWords').textContent = numberToWords(amount) + ' Rupees Only';
            document.getElementById('receiptNotes').textContent = notes || '-';
            document.getElementById('receiptMasjidName').textContent = masjidInfo.name || 'मस्जिद का नाम / MASJID NAME';
            document.getElementById('receiptMasjidAddress').textContent = masjidInfo.address || 'मस्जिद का पता / MASJID ADDRESS';
            
            // Show receipt
            document.getElementById('chandaReceipt').style.display = 'block';
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('receiptQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Chanda Collection: ${donor}, Amount: ₹${amount.toFixed(2)}, Date: ${date}`,
                        width: 100,
                        height: 100
                    });
                }
            }, 100);
            
            // Scroll to receipt
            document.getElementById('chandaReceipt').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Convert number to words
        function numberToWords(num) {
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            
            if ((num = num.toString()).length > 9) return 'overflow';
            const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return;
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'only ' : '';
            return str.trim();
        }
        
        // Download receipt as image
        function downloadReceiptAsImage() {
            const receiptElement = document.getElementById('chandaReceipt');
            
            html2canvas(receiptElement, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `chanda-receipt-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast('Receipt downloaded as image', 'success');
            });
        }
        
        // Share receipt on WhatsApp
        function shareReceiptOnWhatsApp() {
            const receiptElement = document.getElementById('chandaReceipt');
            
            html2canvas(receiptElement, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                // Convert canvas to data URL
                const imageData = canvas.toDataURL('image/png');
                
                // Create a temporary link to download the image
                const link = document.createElement('a');
                link.href = imageData;
                link.download = `chanda-receipt-${new Date().toISOString().split('T')[0]}.png`;
                
                // Get donor name and amount for message
                const donorName = document.getElementById('receiptDonorName').textContent;
                const amount = document.getElementById('receiptAmount').textContent;
                
                // Create WhatsApp message
                const message = `Dear ${donorName},\n\nThank you for your chanda contribution of ${amount}.\n\nPlease find attached your receipt.\n\n${document.getElementById('receiptMasjidName').textContent}`;
                
                // Open WhatsApp with pre-filled message
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Show toast
                showToast('Opening WhatsApp with receipt...', 'success');
            });
        }
        
        // View chanda collection
        function viewChandaCollection(id) {
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            const collection = chandaCollections.find(c => c.id === id);
            
            if (!collection) return;
            
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const collector = committeeMembers.find(m => m.id === collection.collectorId);
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            const content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} Chanda Collection Receipt</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <p><strong>Date:</strong> ${formatDate(collection.date)}</p>
                    <p><strong>Donor:</strong> ${collection.donor}</p>
                    <p><strong>Amount:</strong> ₹${collection.amount.toFixed(2)}</p>
                    <p><strong>Purpose:</strong> ${getChandaPurposeLabel(collection.purpose)}</p>
                    <p><strong>Collector:</strong> ${collector ? collector.name : '-'}</p>
                    ${collection.notes ? `<p><strong>Notes:</strong> ${collection.notes}</p>` : ''}
                </div>
                
                <div class="mb-4 text-center">
                    <div id="chandaQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('chandaQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Chanda Collection ID: ${collection.id}, Amount: ₹${collection.amount.toFixed(2)}, Date: ${collection.date}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Delete chanda collection
        function deleteChandaCollection(id) {
            if (confirm('Are you sure you want to delete this chanda collection?')) {
                const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
                const updatedCollections = chandaCollections.filter(c => c.id !== id);
                localStorage.setItem('chandaCollections', JSON.stringify(updatedCollections));
                
                updateChandaTable(updatedCollections);
                updateChandaSummary(updatedCollections);
                updateSummarySection();
                
                showToast('Chanda collection deleted successfully', 'success');
            }
        }
        
        // Update pending chanda list
        function updatePendingChandaList() {
            const pendingChandaList = document.getElementById('pendingChandaList');
            pendingChandaList.innerHTML = '';
            
            // Get all households
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            
            // Get current month and year
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Find households that haven't paid chanda for the current month
            households.forEach(household => {
                // Check if household is linked to a member
                const link = memberHouseholdLinks.find(l => l.householdId === household.id);
                
                if (link) {
                    // Check if household has paid chanda for current month
                    const hasPaid = chandaCollections.some(c => {
                        const collectionDate = new Date(c.date);
                        return collectionDate.getMonth() === currentMonth && 
                               collectionDate.getFullYear() === currentYear &&
                               c.donor === household.name;
                    });
                    
                    if (!hasPaid) {
                        // Add to pending list
                        const pendingItem = document.createElement('div');
                        pendingItem.className = 'pending-chanda-item';
                        pendingItem.innerHTML = `
                            <div>
                                <strong>${household.name}</strong>
                                ${household.phone ? `<br><small>${household.phone}</small>` : ''}
                            </div>
                            <div class="pending-chanda-actions">
                                <button class="btn btn-sm btn-success send-whatsapp-reminder" data-id="${household.id}" data-name="${household.name}" data-phone="${household.phone || ''}">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                <button class="btn btn-sm btn-primary mark-as-paid" data-id="${household.id}" data-name="${household.name}">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        `;
                        pendingChandaList.appendChild(pendingItem);
                    }
                }
            });
            
            // Add event listeners
            document.querySelectorAll('.send-whatsapp-reminder').forEach(button => {
                button.addEventListener('click', function() {
                    const householdId = this.getAttribute('data-id');
                    const householdName = this.getAttribute('data-name');
                    const householdPhone = this.getAttribute('data-phone');
                    sendWhatsAppReminder(householdId, householdName, householdPhone);
                });
            });
            
            document.querySelectorAll('.mark-as-paid').forEach(button => {
                button.addEventListener('click', function() {
                    const householdId = this.getAttribute('data-id');
                    const householdName = this.getAttribute('data-name');
                    markAsPaid(householdId, householdName);
                });
            });
            
            // Show message if no pending chanda
            if (pendingChandaList.children.length === 0) {
                pendingChandaList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <p>कोई भी बकाया चंदा नहीं है!</p>
                        <p class="text-muted">All households have paid their chanda for this month.</p>
                    </div>
                `;
            }
        }
        
        // Send WhatsApp reminder
        function sendWhatsAppReminder(householdId, householdName, householdPhone) {
            // Get masjid info
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            // Create message in Hindi and English
            const hindiMessage = `प्रिय ${householdName},\n\nआपका मासिक चंदा अभी तक जमा नहीं हुआ है। कृपया जल्द से जल्द अपना चंदा जमा करवाएं।\n\nधन्यवाद,\n${masjidInfo.name || 'मस्जिद'}`;
            
            const englishMessage = `Dear ${householdName},\n\nYour monthly chanda is still pending. Please submit your chanda as soon as possible.\n\nThanks,\n${masjidInfo.name || 'Masjid'}`;
            
            // Combine messages
            const combinedMessage = `${hindiMessage}\n\n---\n\n${englishMessage}`;
            
            // Get WhatsApp numbers
            const whatsappNumbers = masjidInfo.whatsappNumbers || [];
            
            if (whatsappNumbers.length === 0) {
                showToast('No WhatsApp numbers configured. Please add WhatsApp numbers in Masjid Info section.', 'error');
                return;
            }
            
            // If household has a phone number, use it directly
            if (householdPhone) {
                const whatsappUrl = `https://wa.me/${householdPhone.replace(/\D/g, '')}?text=${encodeURIComponent(combinedMessage)}`;
                window.open(whatsappUrl, '_blank');
                showToast('Opening WhatsApp with reminder message...', 'success');
                return;
            }
            
            // Otherwise, show modal to select from masjid numbers
            const modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            
            // Update WhatsApp number select
            updateWhatsAppNumberSelect(whatsappNumbers);
            
            // Update message
            document.getElementById('whatsappMessage').value = combinedMessage;
            document.getElementById('whatsappPreviewText').textContent = combinedMessage;
            
            // Update image preview
            const imagePreview = document.getElementById('whatsappImagePreview');
            imagePreview.innerHTML = `<p class="text-muted">No image attached</p>`;
            
            // Show modal
            modal.show();
        }
        
        // Mark as paid
        function markAsPaid(householdId, householdName) {
            // Get current date
            const now = new Date();
            const formattedDate = formatDateForInput(now);
            
            // Get households and member-household links
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            
            // Find household and link
            const household = households.find(h => h.id == householdId);
            const link = memberHouseholdLinks.find(l => l.householdId == householdId);
            
            if (!household || !link) {
                showToast('Household not found', 'error');
                return;
            }
            
            // Find member
            const member = committeeMembers.find(m => m.id === link.memberId);
            
            // Add donation to link
            const donation = {
                id: Date.now(),
                amount: 0, // Will be set by user
                date: formattedDate
            };
            
            // Ask for amount
            const amount = prompt(`Enter chanda amount for ${householdName}:`);
            
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                donation.amount = parseFloat(amount);
                
                link.donations.push(donation);
                localStorage.setItem('memberHouseholdLinks', JSON.stringify(memberHouseholdLinks));
                
                // Update tables
                updateMemberHouseholdLinksTable(memberHouseholdLinks);
                updatePendingChandaList();
                updateSummarySection();
                
                showToast(`${householdName} marked as paid`, 'success');
            } else if (amount !== null) {
                showToast('Please enter a valid amount', 'error');
            }
        }
        
        // Send WhatsApp alerts to all pending
        function sendWhatsAppAlerts() {
            // Get masjid info
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            // Get WhatsApp numbers
            const whatsappNumbers = masjidInfo.whatsappNumbers || [];
            
            if (whatsappNumbers.length === 0) {
                showToast('No WhatsApp numbers configured. Please add WhatsApp numbers in Masjid Info section.', 'error');
                return;
            }
            
            // Get all pending households
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            
            // Get current month and year
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Find households that haven't paid chanda for the current month
            const pendingHouseholds = households.filter(household => {
                const link = memberHouseholdLinks.find(l => l.householdId === household.id);
                
                if (link) {
                    const hasPaid = chandaCollections.some(c => {
                        const collectionDate = new Date(c.date);
                        return collectionDate.getMonth() === currentMonth && 
                               collectionDate.getFullYear() === currentYear &&
                               c.donor === household.name;
                    });
                    
                    return !hasPaid;
                }
                
                return false;
            });
            
            if (pendingHouseholds.length === 0) {
                showToast('No pending chanda found', 'success');
                return;
            }
            
            // Show confirmation
            if (confirm(`Send WhatsApp reminders to ${pendingHouseholds.length} households?`)) {
                // Generate and send reminders for each household
                pendingHouseholds.forEach((household, index) => {
                    setTimeout(() => {
                        sendWhatsAppReminder(household.id, household.name, household.phone || '');
                    }, index * 1000); // Delay each message by 1 second
                });
                
                showToast(`Sending reminders to ${pendingHouseholds.length} households`, 'success');
            }
        }
        
        // Generate committee report
        function generateCommitteeReport() {
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            const households = JSON.parse(localStorage.getItem('households')) || [];
            const memberHouseholdLinks = JSON.parse(localStorage.getItem('memberHouseholdLinks')) || [];
            
            if (committeeMembers.length === 0) {
                showToast('No committee members found', 'error');
                return;
            }
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            let content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} Committee Members & Households Report</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <h5>Committee Members</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Linked Households</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            committeeMembers.forEach(member => {
                const linkedHouseholds = memberHouseholdLinks.filter(link => link.memberId === member.id);
                const householdNames = linkedHouseholds.map(link => {
                    const household = households.find(h => h.id === link.householdId);
                    return household ? household.name : '';
                }).filter(name => name).join(', ');
                
                content += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${member.phone || '-'}</td>
                        <td>${member.email || '-'}</td>
                        <td>${householdNames || '-'}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mb-4">
                    <h5>Households</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Phone</th>
                                <th>Linked Member</th>
                                <th>Total Donations</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            households.forEach(household => {
                const linkedMember = memberHouseholdLinks.find(link => link.householdId === household.id);
                const member = linkedMember ? committeeMembers.find(m => m.id === linkedMember.memberId) : null;
                const totalDonations = linkedMember ? 
                    linkedMember.donations.reduce((sum, donation) => sum + donation.amount, 0) : 0;
                
                content += `
                    <tr>
                        <td>${household.name}</td>
                        <td>${household.address || '-'}</td>
                        <td>${household.phone || '-'}</td>
                        <td>${member ? member.name : '-'}</td>
                        <td>₹${totalDonations.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Generate donation report
        function generateDonationReport(type) {
            const donations = JSON.parse(localStorage.getItem('donations')) || [];
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            
            let filteredDonations = donations;
            let reportTitle = 'All Donations Report';
            
            if (type !== 'all') {
                filteredDonations = donations.filter(d => d.type === type);
                reportTitle = `${getDonationTypeLabel(type)} Report`;
            }
            
            if (filteredDonations.length === 0) {
                showToast(`No ${type === 'all' ? '' : type + ' '}donations found`, 'error');
                return;
            }
            
            const totalAmount = filteredDonations.reduce((sum, donation) => sum + donation.amount, 0);
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            let content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} ${reportTitle}</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Donations:</strong> ${filteredDonations.length}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Amount:</strong> ₹${totalAmount.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Donor Name</th>
                                <th>Amount (₹)</th>
                                <th>Type</th>
                                <th>Responsible Member</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Sort donations by date (newest first)
            const sortedDonations = [...filteredDonations].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedDonations.forEach(donation => {
                const member = donation.memberId ? committeeMembers.find(m => m.id === donation.memberId) : null;
                
                content += `
                    <tr>
                        <td>${formatDate(donation.date)}</td>
                        <td>${donation.donorName}</td>
                        <td>₹${donation.amount.toFixed(2)}</td>
                        <td>${getDonationTypeLabel(donation.type)}</td>
                        <td>${member ? member.name : '-'}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mb-4 text-center">
                    <div id="donationReportQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('donationReportQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `${reportTitle}: ${filteredDonations.length} donations, Total: ₹${totalAmount.toFixed(2)}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Generate construction report
        function generateConstructionReport() {
            const constructionDonations = JSON.parse(localStorage.getItem('constructionDonations')) || [];
            const constructionExpenses = JSON.parse(localStorage.getItem('constructionExpenses')) || [];
            
            if (constructionDonations.length === 0 && constructionExpenses.length === 0) {
                showToast('No construction data found', 'error');
                return;
            }
            
            const totalDonations = constructionDonations.reduce((sum, donation) => sum + donation.amount, 0);
            const totalExpenses = constructionExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = totalDonations - totalExpenses;
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            let content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} Construction Budget & Expenses Report</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <h4 class="text-success">₹${totalDonations.toFixed(2)}</h4>
                            <p>Total Donations</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <h4 class="text-danger">₹${totalExpenses.toFixed(2)}</h4>
                            <p>Total Expenses</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <h4 class="${remaining < 0 ? 'text-danger' : 'text-primary'}">₹${remaining.toFixed(2)}</h4>
                            <p>Remaining Budget</p>
                        </div>
                    </div>
                </div>
            `;
            
            if (constructionDonations.length > 0) {
                content += `
                    <div class="mb-4">
                        <h5>Construction Donations</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Donor</th>
                                    <th>Amount (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort donations by date (newest first)
                const sortedDonations = [...constructionDonations].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedDonations.forEach(donation => {
                    content += `
                        <tr>
                            <td>${formatDate(donation.date)}</td>
                            <td>${donation.donor}</td>
                            <td>₹${donation.amount.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (constructionExpenses.length > 0) {
                content += `
                    <div class="mb-4">
                        <h5>Construction Expenses</h5>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort expenses by date (newest first)
                const sortedExpenses = [...constructionExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedExpenses.forEach(expense => {
                    content += `
                        <tr>
                            <td>${formatDate(expense.date)}</td>
                            <td>${expense.description}</td>
                            <td>₹${expense.amount.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            content += `
                <div class="mb-4 text-center">
                    <div id="constructionReportQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('constructionReportQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Construction Report: Donations ₹${totalDonations.toFixed(2)}, Expenses ₹${totalExpenses.toFixed(2)}, Remaining ₹${remaining.toFixed(2)}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Generate announcement PDF
        function generateAnnouncementPDF(id) {
            const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
            const announcement = announcements.find(a => a.id === id);
            
            if (!announcement) return;
            
            const priorityClass = {
                low: 'text-success',
                medium: 'text-warning',
                high: 'text-danger'
            };
            
            const priorityLabel = {
                low: 'Low',
                medium: 'Medium',
                high: 'High'
            };
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            const content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} ${announcement.title}</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-3">
                    <p><strong>Date:</strong> ${formatDate(announcement.date)}</p>
                    <p><strong>Priority:</strong> <span class="${priorityClass[announcement.priority]}">${priorityLabel[announcement.priority]}</span></p>
                </div>
                
                ${announcement.image ? `
                    <div class="mb-4 text-center">
                        <img src="${announcement.image}" alt="Announcement Image" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; padding: 5px;">
                    </div>
                ` : ''}
                
                <div class="mb-4">
                    <p>${announcement.content.replace(/\n/g, '<br>')}</p>
                </div>
                
                <div class="mb-4 text-center">
                    <div id="announcementQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('announcementQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `Announcement: ${announcement.title}, Date: ${announcement.date}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Generate chanda report
        function generateChandaReport(purpose) {
            const chandaCollections = JSON.parse(localStorage.getItem('chandaCollections')) || [];
            const committeeMembers = JSON.parse(localStorage.getItem('committeeMembers')) || [];
            
            let filteredCollections = chandaCollections;
            let reportTitle = 'All Chanda Collections Report';
            
            if (purpose !== 'all') {
                filteredCollections = chandaCollections.filter(c => c.purpose === purpose);
                reportTitle = `${getChandaPurposeLabel(purpose)} Report`;
            }
            
            if (filteredCollections.length === 0) {
                showToast(`No ${purpose === 'all' ? '' : purpose + ' '}chanda collections found`, 'error');
                return;
            }
            
            const totalAmount = filteredCollections.reduce((sum, collection) => sum + collection.amount, 0);
            
            // Get masjid info for PDF header
            const masjidInfo = JSON.parse(localStorage.getItem('masjidInfo')) || {};
            
            let content = `
                <div class="islamic-pdf-header">
                    ${masjidInfo.logo ? `<img src="${masjidInfo.logo}" alt="Masjid Logo" style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">` : ''}
                    <h2>${masjidInfo.name || 'Masjid'} ${reportTitle}</h2>
                    <div class="arabic-text">بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ</div>
                </div>
                
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Collections:</strong> ${filteredCollections.length}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Amount:</strong> ₹${totalAmount.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Donor</th>
                                <th>Amount (₹)</th>
                                <th>Purpose</th>
                                <th>Collector</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Sort collections by date (newest first)
            const sortedCollections = [...filteredCollections].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedCollections.forEach(collection => {
                const collector = committeeMembers.find(m => m.id === collection.collectorId);
                
                content += `
                    <tr>
                        <td>${formatDate(collection.date)}</td>
                        <td>${collection.donor}</td>
                        <td>₹${collection.amount.toFixed(2)}</td>
                        <td>${getChandaPurposeLabel(collection.purpose)}</td>
                        <td>${collector ? collector.name : '-'}</td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mb-4 text-center">
                    <div id="chandaReportQrCode"></div>
                </div>
                
                <div class="islamic-pdf-footer">
                    <p>Generated on ${new Date().toLocaleDateString()} | ${masjidInfo.name || 'Masjid Management System'}</p>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = content;
            
            // Generate QR code
            setTimeout(() => {
                const qrCodeContainer = document.getElementById('chandaReportQrCode');
                if (qrCodeContainer) {
                    qrCodeContainer.innerHTML = '';
                    new QRCode(qrCodeContainer, {
                        text: `${reportTitle}: ${filteredCollections.length} collections, Total: ₹${totalAmount.toFixed(2)}`,
                        width: 128,
                        height: 128
                    });
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
        
        // Download PDF
        function downloadPdf(content) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            html2canvas(content, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`${new Date().toISOString().split('T')[0]}_report.pdf`);
            });
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `custom-toast toast-${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const title = type === 'success' ? 'Success' : 'Error';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-message">
                    <div class="toast-title">${title}</div>
                    <div>${message}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Add event listener to close button
            toast.querySelector('.toast-close').addEventListener('click', function() {
                toast.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
</html>
