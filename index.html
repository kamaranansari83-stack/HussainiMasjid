<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apni Masjid — Masjid Management (Offline)</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg1: #07e38b;
      --bg2: #07a7eb;
      --card: #ffffff;
      --accent: #03f58c;
      --muted: #8d75cbc4;
      --radius: 14px;
      --naskh: 'Amiri', serif;
      --ui: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:var(--ui);background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#030303}
    .wrap{max-width:1200px;margin:18px auto;padding:18px;}
    header{display:flex;gap:12px;align-items:center;background:linear-gradient(90deg,#ede906, #02b4fb);color:#d901ff;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(247, 255, 4, 0.722)}
    header img.logo{width:82px;height:82px;object-fit:cover;border-radius:12px;border:3px solid rgb(255, 0, 0)}
    header .title{font-family:var(--naskh);font-size:22px;font-weight:700}
    header .subtitle{font-size:13px;opacity:0.9}
    .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:#0066ff;padding:10px 12px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgb(117, 255, 4);color:var(--accent)}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-top:14px;box-shadow:0 6px 20px rgb(0, 132, 255)}
    h3{margin:0 0 8px 0;font-family:var(--naskh)}
    .grid{display:grid;gap:12px}
    .cols-3{grid-template-columns:1fr 1fr 1fr}
    .cols-2{grid-template-columns:1fr 1fr}
    .flex{display:flex;gap:10px;align-items:center}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #00ccff;background:transparent;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #00ff9581;text-align:left;font-size:14px}
    th{background:linear-gradient(90deg,#f0f400fc,#00ff9d);color:#0055ff;border-radius:6px}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .right{text-align:right}
    .img-preview{width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #02f18a}
    .pill{display:inline-block;padding:6px 10px;background:#0022e3;color:var(--accent);border-radius:999px;font-weight:700}
    .small-btn{padding:6px 8px;border-radius:8px;border:0;background:#ffdd00a3;color:var(--accent);cursor:pointer}
    .watermark{background-image: radial-gradient(circle at 10% 10%, rgb(0, 100, 251), transparent 20%), radial-gradient(circle at 90% 90%, rgb(0, 255, 145), transparent 20%); padding:18px;border-radius:12px;}
    .hidden { display:none; }

    /* Quick Announcement & Image share styles */
    .quick-ann-card{display:flex;gap:12px;flex-direction:column}
    .islamic-bg {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="%23fdfbf6"/><g fill="%230b5d3a33"><circle cx="50" cy="50" r="20"/><circle cx="150" cy="50" r="20"/></g><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="28" opacity="0.04" fill="black">سُبْحَانَ اللّٰهِ</text></svg>');
      background-size: cover;
      border-radius:12px;padding:14px;
    }
    .announce-row{display:flex;gap:8px;align-items:center}
    .announce-text{flex:1;padding:10px;border-radius:10px;border:1px dashed #00ccff;background:linear-gradient(180deg,#ffffff,#ffffff)}
    .share-actions{display:flex;gap:8px;align-items:center}
    @media (max-width:980px){ .cols-3,.cols-2{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start;gap:8px} .toolbar{margin-left:0} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img id="mosque-logo" class="logo" src="" alt="Masjid Logo" onerror="this.style.display='none'"/>
      <div>
        <div class="title" id="mosque-title">Apni Masjid — Management</div>
        <div class="subtitle muted" id="mosque-sub">Offline Islamic masjid management app — donations, jumma, construction budget, reports</div>
      </div>

      <div class="toolbar">
        <button id="export-all">Export Summary PDF</button>
        <button id="export-notice" class="ghost">Create Islamic Notice</button>
        <button id="generate-qr" class="ghost"><i class="fa fa-qrcode"></i> QR</button>
      </div>
    </header>

    <!-- Masjid Info -->
    <section class="card" id="mosque-info-card">
      <h3>Masjid Info</h3>
      <div class="grid cols-3">
        <div>
          <label>Masjid ka Naam</label>
          <input type="text" id="mosque-name" placeholder="Masjid ka naam likhen" />
        </div>
        <div>
          <label>Address (optional)</label>
          <input type="text" id="mosque-address" placeholder="Address likhen" />
        </div>
        <div>
          <label>Logo / Photo</label>
          <input type="file" id="logo-file" accept="image/*" />
          <div class="mt8"><img id="logo-preview" class="img-preview" src="" alt="Preview" style="display:none"/></div>
        </div>
      </div>
      <div class="mt8">
        <button id="save-mosque">Save Masjid Info</button>
        <button id="reset-data" class="ghost">Reset All Data</button>
      </div>
    </section>

    <!-- Committee Members & Households -->
    <section class="card">
      <h3>Committee Members & Households</h3>
      <div class="grid cols-2">
        <div>
          <label>Committee Member ka Naam</label>
          <input type="text" id="member-name" placeholder="e.g., Haji Umar" />
          <label class="mt8">Member Phone / Note (optional)</label>
          <input type="text" id="member-note" placeholder="Phone ya note" />
          <div class="mt8">
            <button id="add-member">Add Committee Member</button>
          </div>
        </div>

        <div>
          <label>Add Household to Selected Member</label>
          <select id="select-member-to-add-household"><option value="">-- Select Member --</option></select>
          <label class="mt8">Household Name / Head</label>
          <input type="text" id="household-name" placeholder="e.g., Ghar No 1 - Ali" />
          <label class="mt8">Household Note (Address / Family Count)</label>
          <input type="text" id="household-note" placeholder="e.g., 6 log, address" />
          <div class="mt8">
            <button id="add-household">Add Household</button>
          </div>
        </div>
      </div>

      <div class="mt8">
        <div class="search">
          <input type="text" id="search-members" placeholder="Search members or households..." />
          <div class="pill">Search</div>
        </div>
      </div>

      <div class="mt8 table-scroll card" style="padding:8px;">
        <table id="members-table">
          <thead><tr><th>Member</th><th>Households</th><th>Note</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Donations -->
    <section class="card">
      <h3>Donations / Chanda (Monthly) & Cemetery & Jumma</h3>

      <div class="grid cols-3">
        <div>
          <label>Donation Date</label>
          <input type="date" id="donation-date" value="" />
          <label class="mt8">Amount (₹)</label>
          <input type="text" id="donation-amount" placeholder="e.g., 500 or 'Five Hundred' (alphabets allowed)" />
        </div>

        <div>
          <label>Donation Type</label>
          <select id="donation-type">
            <option value="monthly">Monthly Chanda</option>
            <option value="cemetery">Qabristan / Cemetery</option>
            <option value="jumma">Jumma Collection</option>
            <option value="other">Other</option>
          </select>

          <label class="mt8">From (Member or Household)</label>
          <select id="donation-from">
            <option value="">-- Select Member / Household --</option>
          </select>
        </div>

        <div>
          <label>Note (optional)</label>
          <input type="text" id="donation-note" placeholder="e.g., Ramadan chanda" />
          <div style="margin-top:8px">
            <button id="add-donation">Add Donation</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="flex">
        <div class="search" style="flex:1">
          <input type="text" id="search-donations" placeholder="Search donations by donor, type, note..." />
          <div class="pill">Search</div>
        </div>
        <div style="margin-left:auto" class="flex">
          <label style="margin-right:8px">Upload QR (for donation):</label>
          <input type="file" id="qr-upload" accept="image/*" style="display:inline-block"/>
          <img id="qr-preview" src="" alt="QR preview" style="width:64px;height:64px;object-fit:contain;border-radius:6px;margin-left:8px;display:none;border:1px solid #eee"/>
          <button id="export-csv" class="ghost">Export CSV</button>
        </div>
      </div>

      <div class="mt8 table-scroll card" style="padding:8px;">
        <table id="donations-table">
          <thead><tr><th>Date</th><th>Type</th><th>From</th><th>Amount</th><th>Note</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Jumma Collections & Expenses -->
    <section class="card">
      <h3>Jumma Collection & Uska Kharch</h3>
      <div class="grid cols-3">
        <div>
          <label>Jumma Date</label>
          <input type="date" id="jumma-date" value="" />
          <label class="mt8">Amount Collected (₹)</label>
          <input type="text" id="jumma-amount" placeholder="e.g., 2000 or 'Two Thousand'" />
        </div>

        <div>
          <label>Collected By (Member/Volunteer)</label>
          <select id="jumma-collected-by">
            <option value="">-- Select --</option>
          </select>

          <label class="mt8">Note (optional)</label>
          <input type="text" id="jumma-note" placeholder="e.g., special khutbah collection" />
        </div>

        <div>
          <label>Kharch (Expense) for Jumma</label>
          <input type="text" id="jumma-expense-amount" placeholder="Expense amount or text" />
          <label class="mt8">Expense Note</label>
          <input type="text" id="jumma-expense-note" placeholder="e.g., REPAIRING, CLEANING" />
        </div>
      </div>

      <div style="margin-top:10px" class="flex">
        <button id="add-jumma">Add Jumma Collection</button>
        <button id="export-jumma-ledger" class="ghost">Export Jumma Ledger PDF</button>
        <div style="margin-left:auto" class="muted"> </div>
      </div>

      <div style="margin-top:12px" class="search">
        <input type="text" id="search-jumma" placeholder="Search jumma by date, note, collector..." />
        <div class="pill">Search</div>
      </div>

      <div class="mt8 table-scroll card" style="padding:8px;">
        <table id="jumma-table">
          <thead><tr><th>Date</th><th>Collected By</th><th>Collected</th><th>Expense</th><th>Net</th><th>Note</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Construction Budget -->
    <section class="card">
      <h3>Masjid Construction Budget :-- </h3>

      <div class="grid cols-3">
        <div>
          <label>Contribution Date</label>
          <input type="date" id="construction-date" />
          <label class="mt8">Contributor Name</label>
          <input type="text" id="construction-contributor" placeholder="Kaun jama kar raha hai" />
          <label class="mt8">Amount (₹ or text)</label>
          <input type="text" id="construction-amount" placeholder="e.g., 10000 or 'Ten Thousand'" />
        </div>

        <div>
          <label>Contributor Contact (optional)</label>
          <input type="text" id="construction-contact" placeholder="Phone / note" />
          <label class="mt8">Contribution Type</label>
          <select id="construction-type">
            <option value="donation">Donation</option>
            <option value="loan">Loan</option>
            <option value="materials">Materials</option>
          </select>
          <div style="margin-top:8px">
            <button id="add-contribution">Add Contribution</button>
          </div>
        </div>

        <div>
          <label>Construction Expense Date</label>
          <input type="date" id="construction-expense-date" />
          <label class="mt8">Expense For</label>
          <input type="text" id="construction-expense-for" placeholder="e.g., bricks, labour" />
          <label class="mt8">Expense Amount (₹ or text)</label>
          <input type="text" id="construction-expense-amount" />
          <div style="margin-top:8px">
            <button id="add-construction-expense" class="ghost">Add Expense</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="search">
        <input type="text" id="search-construction" placeholder="Search contributors or expenses..." />
        <div class="pill">Search</div>
      </div>

      <div style="margin-top:10px" class="grid cols-2">
        <div class="card">
          <h4>Contributors</h4>
          <table id="construction-contributors-table"><thead><tr><th>Date</th><th>Name</th><th>Amount</th><th>Contact</th><th>Type</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h4>Expenses</h4>
          <div style="margin-bottom:8px" class="flex">
            <div><strong>Select expense then:</strong></div>
            <div style="margin-left:auto" class="share-actions">
              <button id="create-expense-image" class="ghost">Create Image (Islamic BG)</button>
              <button id="copy-expense-image" class="ghost">Copy Image</button>
              <button id="open-expense-image" class="ghost">Open Image</button>
            </div>
          </div>
          <table id="construction-expenses-table"><thead><tr><th></th><th>Date</th><th>For</th><th>Amount</th><th>Note</th><th>Actions</th></tr></thead><tbody></tbody></table>
          <div style="margin-top:8px;font-size:12px;color:#666">Note: Select one expense row (radio) and click "Create Image" to generate an Islamic-styled image (not PDF) ready to share.</div>
        </div>
      </div>

      <div style="margin-top:12px" class="flex">
        <div><strong>Total Raised:</strong> <span id="construction-total-raised">₹ 0</span></div>
        <div style="margin-left:12px"><strong>Total Spent:</strong> <span id="construction-total-spent">₹ 0</span></div>
        <div style="margin-left:12px"><strong>Balance:</strong> <span id="construction-balance">₹ 0</span></div>
        <div style="margin-left:auto"><button id="export-construction-report" class="ghost">Export Construction Report</button></div>
      </div>
    </section>

    <!-- Quick Announcement (NEW: not a PDF) -->
    <section class="card">
      <h3>Quick Announcement / ताज़ा सूचना:- </h3>
      <div class="quick-ann-card islamic-bg">
        <div>
          <label>Announcement Title</label>
          <input type="text" id="quick-title" placeholder="e.g., हालिया खर्च के बारे में सूचना" />
        </div>
        <div>
          <label>Message (यह जो भी लिखा जाएगा वही copy होगा; कई भाषाओं में लिखें)</label>
          <textarea id="quick-message" placeholder="यहाँ खर्च या जरूरी सूचना लिखें..."></textarea>
        </div>

        <div class="announce-row">
          <div class="announce-text" id="quick-preview">Preview will appear here with Islamic background</div>
        </div>

        <div class="share-actions">
          <button id="copy-quick-text">📋 Copy & Share (Text)</button>
          <button id="create-quick-image" class="ghost">🖼️ Create Image (Islamic BG)</button>
          <button id="open-quick-image" class="ghost">🔍 Open Image</button>
        </div>

        <div style="font-size:12px;color:#666"></div>
      </div>
    </section>

    <!-- Summary & Ledger -->
    <section class="card watermark">
      <h3>Summary & Reports</h3>
      <div class="grid cols-3">
        <div class="center">
          <div class="muted">Total Collected</div>
          <div class="pill" id="total-collected">₹ 0</div>
        </div>
        <div class="center">
          <div class="muted">Total Jumma Net</div>
          <div class="pill" id="total-jumma">₹ 0</div>
        </div>
        <div class="center">
          <div class="muted">Construction Balance</div>
          <div class="pill" id="construction-summary">₹ 0</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Select Member to view ledger</label>
        <select id="ledger-member"><option value="">-- All / Select Member --</option></select>
        <div style="margin-top:8px" class="table-scroll card">
          <table id="ledger-table">
            <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Note</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:8px" class="flex">
          <button id="export-ledger" class="ghost">Export Ledger PDF</button>
        </div>
      </div>
    </section>

    <footer class="muted card center">
      “अल्लाह तआला ने कुरआन मजीद में फरमाया है:
‘जो लोग अल्लाह की मस्जिदों को आबाद करते हैं, वही लोग ईमान वाले हैं।’ (सूरह तौबा 18)
    </footer>
  </div>

  <script>
    /* ---------------------------
       App state and helpers
       (Keeps previous features unchanged; adds Quick Announcement,
       expense -> image share, QR upload fix.)
       --------------------------- */

    const STORAGE_KEY = 'masjid_mgmt_v3';
    const defaultState = {
      mosque: { id: genId(), name: 'Apni Masjid', address: '', logo: '' },
      members: [],
      donations: [],
      jumma: [],
      construction: { contributions: [], expenses: [] },
      ui: { qrImageData: '' } // store uploaded QR image data URI
    };
    function genId(){ return 'id_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

    let state = loadState();

    // DOM refs (subset)
    const mosqueTitleEl = document.getElementById('mosque-title');
    const mosqueSubEl = document.getElementById('mosque-sub');
    const mosqueLogoEl = document.getElementById('mosque-logo');
    const mosqueNameInput = document.getElementById('mosque-name');
    const mosqueAddressInput = document.getElementById('mosque-address');
    const logoFileInput = document.getElementById('logo-file');
    const logoPreview = document.getElementById('logo-preview');
    const saveMosqueBtn = document.getElementById('save-mosque');
    const resetDataBtn = document.getElementById('reset-data');

    const memberNameInput = document.getElementById('member-name');
    const memberNoteInput = document.getElementById('member-note');
    const addMemberBtn = document.getElementById('add-member');
    const membersTableBody = document.querySelector('#members-table tbody');
    const selectMemberToAddHousehold = document.getElementById('select-member-to-add-household');
    const householdNameInput = document.getElementById('household-name');
    const householdNoteInput = document.getElementById('household-note');
    const addHouseholdBtn = document.getElementById('add-household');
    const searchMembersInput = document.getElementById('search-members');

    const donationDateInput = document.getElementById('donation-date');
    const donationAmountInput = document.getElementById('donation-amount');
    const donationTypeSel = document.getElementById('donation-type');
    const donationFromSel = document.getElementById('donation-from');
    const donationNoteInput = document.getElementById('donation-note');
    const addDonationBtn = document.getElementById('add-donation');
    const donationsTableBody = document.querySelector('#donations-table tbody');
    const searchDonationsInput = document.getElementById('search-donations');
    const exportCsvBtn = document.getElementById('export-csv');

    const qrUploadInput = document.getElementById('qr-upload');
    const qrPreviewImg = document.getElementById('qr-preview');

    const jummaDateInput = document.getElementById('jumma-date');
    const jummaAmountInput = document.getElementById('jumma-amount');
    const jummaCollectedBySel = document.getElementById('jumma-collected-by');
    const jummaNoteInput = document.getElementById('jumma-note');
    const jummaExpenseAmountInput = document.getElementById('jumma-expense-amount');
    const jummaExpenseNoteInput = document.getElementById('jumma-expense-note');
    const addJummaBtn = document.getElementById('add-jumma');
    const jummaTableBody = document.querySelector('#jumma-table tbody');
    const searchJummaInput = document.getElementById('search-jumma');
    const exportJummaBtn = document.getElementById('export-jumma-ledger');

    const constructionDateInput = document.getElementById('construction-date');
    const constructionContributorInput = document.getElementById('construction-contributor');
    const constructionAmountInput = document.getElementById('construction-amount');
    const constructionContactInput = document.getElementById('construction-contact');
    const constructionTypeSel = document.getElementById('construction-type');
    const addContributionBtn = document.getElementById('add-contribution');

    const constructionExpenseDateInput = document.getElementById('construction-expense-date');
    const constructionExpenseForInput = document.getElementById('construction-expense-for');
    const constructionExpenseAmountInput = document.getElementById('construction-expense-amount');
    const addConstructionExpenseBtn = document.getElementById('add-construction-expense');

    const contributorsTableBody = document.querySelector('#construction-contributors-table tbody');
    const expensesTableBody = document.querySelector('#construction-expenses-table tbody');
    const searchConstructionInput = document.getElementById('search-construction');
    const constructionTotalRaisedEl = document.getElementById('construction-total-raised');
    const constructionTotalSpentEl = document.getElementById('construction-total-spent');
    const constructionBalanceEl = document.getElementById('construction-balance');
    const exportConstructionBtn = document.getElementById('export-construction-report');

    const totalCollectedEl = document.getElementById('total-collected');
    const totalJummaEl = document.getElementById('total-jumma');
    const constructionSummaryEl = document.getElementById('construction-summary');
    const ledgerMemberSel = document.getElementById('ledger-member');
    const ledgerTableBody = document.querySelector('#ledger-table tbody');
    const exportLedgerBtn = document.getElementById('export-ledger');

    const exportAllBtn = document.getElementById('export-all');
    const exportNoticeBtn = document.getElementById('export-notice');
    const qrButton = document.getElementById('generate-qr');

    // Quick announcement refs
    const quickTitle = document.getElementById('quick-title');
    const quickMessage = document.getElementById('quick-message');
    const quickPreview = document.getElementById('quick-preview');
    const copyQuickTextBtn = document.getElementById('copy-quick-text');
    const createQuickImageBtn = document.getElementById('create-quick-image');
    const openQuickImageBtn = document.getElementById('open-quick-image');

    // Expense image controls
    const createExpenseImageBtn = document.getElementById('create-expense-image');
    const copyExpenseImageBtn = document.getElementById('copy-expense-image');
    const openExpenseImageBtn = document.getElementById('open-expense-image');

    // keep last generated canvas blob for copy/open
    let lastGeneratedExpenseBlob = null;
    let lastGeneratedQuickBlob = null;

    // init
    (function init(){
      donationDateInput.value = new Date().toISOString().slice(0,10);
      jummaDateInput.value = new Date().toISOString().slice(0,10);
      constructionDateInput.value = new Date().toISOString().slice(0,10);
      constructionExpenseDateInput.value = new Date().toISOString().slice(0,10);
      renderAllUI();
      wireEvents();
    })();

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return JSON.parse(JSON.stringify(defaultState));
        return JSON.parse(raw);
      }catch(e){
        console.error('loadState', e);
        return JSON.parse(JSON.stringify(defaultState));
      }
    }
    function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){console.error(e);} }

    function wireEvents(){
      logoFileInput.addEventListener('change', handleLogoUpload);
      saveMosqueBtn.addEventListener('click', saveMosqueInfo);
      resetDataBtn.addEventListener('click', resetAllData);

      addMemberBtn.addEventListener('click', handleAddMember);
      addHouseholdBtn.addEventListener('click', handleAddHousehold);
      searchMembersInput.addEventListener('input', renderMembersTable);

      addDonationBtn.addEventListener('click', handleAddDonation);
      searchDonationsInput.addEventListener('input', renderDonationsTable);
      exportCsvBtn.addEventListener('click', exportAllCSV);

      qrUploadInput.addEventListener('change', handleQrUpload);

      addJummaBtn.addEventListener('click', handleAddJumma);
      searchJummaInput.addEventListener('input', renderJummaTable);
      exportJummaBtn.addEventListener('click', exportJummaPDF);

      addContributionBtn.addEventListener('click', handleAddContribution);
      addConstructionExpenseBtn.addEventListener('click', handleAddConstructionExpense);
      searchConstructionInput.addEventListener('input', renderConstructionTables);
      exportConstructionBtn.addEventListener('click', exportConstructionReport);

      ledgerMemberSel.addEventListener('change', renderLedgerForMember);
      exportLedgerBtn.addEventListener('click', exportLedgerPDF);

      exportAllBtn.addEventListener('click', exportSummaryPDF);
      exportNoticeBtn.addEventListener('click', createIslamicNoticePDF);
      qrButton.addEventListener('click', openQRCodeDialog);

      copyQuickTextBtn.addEventListener('click', copyQuickTextToClipboard);
      createQuickImageBtn.addEventListener('click', createQuickAnnouncementImage);
      openQuickImageBtn.addEventListener('click', openLastQuickImage);

      createExpenseImageBtn.addEventListener('click', handleCreateExpenseImage);
      copyExpenseImageBtn.addEventListener('click', handleCopyExpenseImage);
      openExpenseImageBtn.addEventListener('click', handleOpenExpenseImage);

      window.addEventListener('beforeunload', ()=> saveState());
    }

    /* -----------------------
       Logo & QR upload handlers
       ----------------------- */
    function handleLogoUpload(e){
      const file = e.target.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        state.mosque.logo = r.result;
        logoPreview.src = r.result; logoPreview.style.display='inline-block';
        mosqueLogoEl.src = r.result; mosqueLogoEl.style.display='inline-block';
        saveState();
      };
      r.readAsDataURL(file);
    }

    function handleQrUpload(e){
      const file = e.target.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        state.ui.qrImageData = r.result; // store data URI
        qrPreviewImg.src = r.result; qrPreviewImg.style.display = 'inline-block';
        saveState();
      };
      r.readAsDataURL(file);
    }

    /* -----------------------
       Mosque info
       ----------------------- */
    function saveMosqueInfo(){
      state.mosque.name = mosqueNameInput.value.trim() || state.mosque.name;
      state.mosque.address = mosqueAddressInput.value.trim() || '';
      mosqueTitleEl.textContent = state.mosque.name + ' — Management';
      mosqueSubEl.textContent = state.mosque.address || '';
      saveState();
      alert('Masjid info saved.');
      renderAllUI();
    }
    function resetAllData(){
      if(!confirm('Kya aap sab data reset karna chahte hain? Ye action wapas nahi hoga.')) return;
      state = JSON.parse(JSON.stringify(defaultState));
      saveState();
      location.reload();
    }

    /* -----------------------
       Members & Households
       ----------------------- */
    function handleAddMember(){
      const name = memberNameInput.value.trim();
      const note = memberNoteInput.value.trim();
      if(!name){ alert('Member ka naam likhen'); return; }
      state.members.push({ id: genId(), name, note, households: [] });
      saveState();
      memberNameInput.value=''; memberNoteInput.value='';
      renderAllUI();
    }
    function handleAddHousehold(){
      const memberId = selectMemberToAddHousehold.value;
      if(!memberId){ alert('Pehle member select karo'); return; }
      const hname = householdNameInput.value.trim();
      if(!hname){ alert('Household name likhen'); return; }
      const hnote = householdNoteInput.value.trim();
      const member = state.members.find(m=>m.id===memberId);
      if(!member) { alert('Member nahi mila'); return; }
      member.households.push({ id: genId(), name: hname, note: hnote });
      saveState();
      householdNameInput.value=''; householdNoteInput.value='';
      renderAllUI();
    }
    function deleteMember(memberId){
      if(!confirm('Member delete karne par uske households aur donations bhi delete ho sakte hain. Continue?')) return;
      const member = state.members.find(m=>m.id===memberId);
      const houseIds = (member && member.households) ? member.households.map(h=>h.id) : [];
      state.donations = state.donations.filter(d => !(d.fromId === memberId || houseIds.includes(d.fromId)));
      state.jumma = state.jumma.map(j=> j.collectorId===memberId ? {...j, collectorId:'', collectorName:'(deleted)'} : j);
      state.members = state.members.filter(m=>m.id !== memberId);
      saveState();
      renderAllUI();
    }
    function deleteHousehold(memberId, householdId){
      if(!confirm('Household delete karna hai? Donations linked delete ho sakte hain.')) return;
      state.donations = state.donations.filter(d=>d.fromId !== householdId);
      const member = state.members.find(m=>m.id===memberId);
      if(!member) return;
      member.households = member.households.filter(h=>h.id !== householdId);
      saveState(); renderAllUI();
    }
    window.editMemberHandler = function(id){
      const m = state.members.find(x=>x.id===id);
      if(!m) return;
      const newName = prompt('Member ka naya naam', m.name);
      if(newName===null) return;
      m.name = newName.trim() || m.name;
      const newNote = prompt('Member note', m.note||'');
      if(newNote!==null) m.note = newNote.trim();
      saveState(); renderAllUI();
    };
    window.deleteMemberHandler = function(id){ deleteMember(id); };
    window.deleteHouseholdHandler = function(memberId, householdId){ deleteHousehold(memberId, householdId); };

    /* -----------------------
       Donations (text amounts allowed)
       ----------------------- */
    function parseAmountInput(raw){
      if(raw === undefined || raw === null) return { raw:'', display:'' };
      const s = String(raw).trim();
      const num = Number(s.replace(/,/g,''));
      if(!isNaN(num) && s.match(/[0-9]/)) return { raw: num, display: s };
      return { raw: s, display: s };
    }
    function handleAddDonation(){
      const date = donationDateInput.value || new Date().toISOString().slice(0,10);
      const parsed = parseAmountInput(donationAmountInput.value || '');
      const type = donationTypeSel.value;
      const fromId = donationFromSel.value || '';
      const fromName = donationFromSel.options[donationFromSel.selectedIndex]?.text || '';
      const note = donationNoteInput.value.trim();
      if((parsed.raw === '' || parsed.raw === 0) && String(parsed.display).trim()===''){ alert('Sahi amount daalo'); return; }
      state.donations.push({ id: genId(), date, type, amountRaw: parsed.raw, amountDisplay: parsed.display, fromId, fromName, note });
      saveState();
      donationAmountInput.value=''; donationNoteInput.value='';
      renderAllUI();
    }
    function editDonation(id){
      const d = state.donations.find(x=>x.id===id); if(!d) return;
      const newDate = prompt('New date', d.date) || d.date;
      const newAmount = prompt('Amount (you can write alphabets too)', d.amountDisplay) || d.amountDisplay;
      const newNote = prompt('Note', d.note || '') || d.note;
      d.date = newDate;
      const parsed = parseAmountInput(newAmount);
      d.amountRaw = parsed.raw; d.amountDisplay = parsed.display; d.note = newNote;
      saveState(); renderAllUI();
    }
    function deleteDonation(id){ if(!confirm('Donation record delete karna hai?')) return; state.donations = state.donations.filter(d=>d.id !== id); saveState(); renderAllUI(); }

    /* -----------------------
       Jumma handlers
       ----------------------- */
    function handleAddJumma(){
      const date = jummaDateInput.value || new Date().toISOString().slice(0,10);
      const parsed = parseAmountInput(jummaAmountInput.value || '');
      const collectorId = jummaCollectedBySel.value || '';
      const collectorName = jummaCollectedBySel.options[jummaCollectedBySel.selectedIndex]?.text || '';
      const expenseParsed = parseAmountInput(jummaExpenseAmountInput.value || '');
      const expenseNote = jummaExpenseNoteInput.value.trim();
      const note = jummaNoteInput.value.trim();
      if((parsed.raw === '' || parsed.raw === 0) && String(parsed.display).trim()===''){ alert('Jumma ke liye sahi amount daalo'); return; }
      state.jumma.push({ id: genId(), date, collectorId, collectorName, amountRaw: parsed.raw, amountDisplay: parsed.display, expenseRaw: expenseParsed.raw, expenseDisplay: expenseParsed.display, expenseNote, note });
      state.donations.push({ id: genId(), date, type:'jumma', amountRaw: parsed.raw, amountDisplay: parsed.display, fromId: collectorId, fromName: collectorName, note: note || ('Jumma: '+(collectorName||''))});
      saveState(); jummaAmountInput.value=''; jummaExpenseAmountInput.value=''; jummaNoteInput.value=''; jummaExpenseNoteInput.value=''; renderAllUI();
    }
    function deleteJumma(id){ if(!confirm('Jumma record delete karna hai?')) return; state.jumma = state.jumma.filter(j=>j.id !== id); // best-effort remove related donations
      state.donations = state.donations.filter(d => !(d.type==='jumma' && state.jumma.every(j=> !(j.date===d.date && j.amountDisplay===d.amountDisplay))));
      saveState(); renderAllUI();
    }
    function editJumma(id){ const j = state.jumma.find(x=>x.id===id); if(!j) return;
      const newDate = prompt('New date', j.date) || j.date;
      const newAmount = prompt('Amount (text allowed)', j.amountDisplay) || j.amountDisplay;
      const newExpense = prompt('Expense amount (text allowed)', j.expenseDisplay || '') || j.expenseDisplay || '';
      const newNote = prompt('Note', j.note || '') || j.note;
      j.date = newDate;
      const parsed = parseAmountInput(newAmount); j.amountRaw = parsed.raw; j.amountDisplay = parsed.display;
      const eparsed = parseAmountInput(newExpense); j.expenseRaw = eparsed.raw; j.expenseDisplay = eparsed.display; j.note = newNote;
      saveState(); renderAllUI();
    }

    /* -----------------------
       Construction handlers
       ----------------------- */
    function handleAddContribution(){
      const date = constructionDateInput.value || new Date().toISOString().slice(0,10);
      const name = constructionContributorInput.value.trim();
      const parsed = parseAmountInput(constructionAmountInput.value || '');
      const contact = constructionContactInput.value.trim();
      const type = constructionTypeSel.value || 'donation';
      if(!name || (parsed.raw === '' && String(parsed.display).trim()==='')){ alert('Contributor name aur sahi amount do'); return; }
      state.construction.contributions.push({ id: genId(), date, name, amountRaw: parsed.raw, amountDisplay: parsed.display, contact, type });
      saveState(); constructionContributorInput.value=''; constructionAmountInput.value=''; constructionContactInput.value=''; renderAllUI();
    }
    function handleAddConstructionExpense(){
      const date = constructionExpenseDateInput.value || new Date().toISOString().slice(0,10);
      const forWhat = constructionExpenseForInput.value.trim();
      const parsed = parseAmountInput(constructionExpenseAmountInput.value || '');
      if(!forWhat || (parsed.raw === '' && String(parsed.display).trim()==='')){ alert('Expense reason aur amount do'); return; }
      state.construction.expenses.push({ id: genId(), date, for: forWhat, amountRaw: parsed.raw, amountDisplay: parsed.display, note: '' });
      saveState(); constructionExpenseForInput.value=''; constructionExpenseAmountInput.value=''; renderAllUI();
    }
    function deleteContribution(id){ if(!confirm('Contribution delete karna hai?')) return; state.construction.contributions = state.construction.contributions.filter(c=>c.id !== id); saveState(); renderAllUI(); }
    function deleteConstructionExpense(id){ if(!confirm('Expense delete karna hai?')) return; state.construction.expenses = state.construction.expenses.filter(e=>e.id !== id); saveState(); renderAllUI(); }
    function editContribution(id){ const c = state.construction.contributions.find(x=>x.id===id); if(!c) return;
      const newDate = prompt('Date', c.date) || c.date; const newName = prompt('Contributor Name', c.name) || c.name; const newAmount = prompt('Amount (text allowed)', c.amountDisplay) || c.amountDisplay; const newContact = prompt('Contact', c.contact||'') || c.contact;
      c.date = newDate; c.name = newName; const parsed = parseAmountInput(newAmount); c.amountRaw = parsed.raw; c.amountDisplay = parsed.display; c.contact = newContact; saveState(); renderAllUI();
    }
    function editConstructionExpense(id){ const e = state.construction.expenses.find(x=>x.id===id); if(!e) return;
      const newDate = prompt('Date', e.date) || e.date; const newFor = prompt('Expense for', e.for) || e.for; const newAmount = prompt('Amount (text allowed)', e.amountDisplay) || e.amountDisplay; const newNote = prompt('Note', e.note||'') || e.note;
      e.date=newDate; e.for=newFor; e.note=newNote; const parsed = parseAmountInput(newAmount); e.amountRaw = parsed.raw; e.amountDisplay = parsed.display; saveState(); renderAllUI();
    }

    /* -----------------------
       Renderers
       ----------------------- */
    function renderAllUI(){
      mosqueTitleEl.textContent = state.mosque.name + ' — Management';
      mosqueSubEl.textContent = state.mosque.address || '';
      mosqueNameInput.value = state.mosque.name || ''; mosqueAddressInput.value = state.mosque.address || '';
      if(state.mosque.logo){ mosqueLogoEl.src = state.mosque.logo; mosqueLogoEl.style.display='inline-block'; logoPreview.src = state.mosque.logo; logoPreview.style.display='inline-block'; } else { mosqueLogoEl.style.display='none'; logoPreview.style.display='none'; }
      // QR preview from stored data
      if(state.ui.qrImageData){ qrPreviewImg.src = state.ui.qrImageData; qrPreviewImg.style.display='inline-block'; } else { qrPreviewImg.style.display='none'; }

      renderMembersTable(); populateDonationFromOptions(); renderDonationsTable(); renderSummary(); populateLedgerMembers(); renderLedgerForMember(); renderJummaTable(); renderConstructionTables(); updateQuickPreview();
    }

    function renderMembersTable(){
      membersTableBody.innerHTML=''; selectMemberToAddHousehold.innerHTML = '<option value="">-- Select Member --</option>'; jummaCollectedBySel.innerHTML = '<option value="">-- Select --</option>';
      const q = (searchMembersInput.value||'').toLowerCase().trim();
      state.members.forEach(member=>{
        const opt = document.createElement('option'); opt.value = member.id; opt.text = member.name + ' (Member)'; selectMemberToAddHousehold.appendChild(opt);
        const opt2 = document.createElement('option'); opt2.value = member.id; opt2.text = member.name; jummaCollectedBySel.appendChild(opt2);

        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.innerHTML = `<strong>${escapeHtml(member.name)}</strong>`; tr.appendChild(tdName);
        const tdHouse = document.createElement('td');
        if(member.households && member.households.length){
          tdHouse.innerHTML = member.households.map(h=>`<div style="margin-bottom:6px"><b>${escapeHtml(h.name)}</b> <span class="muted">(${escapeHtml(h.note)})</span> <button class="small-btn" onclick="window.deleteHouseholdHandler('${member.id}','${h.id}')">Delete</button></div>`).join('');
        } else tdHouse.textContent='—';
        tr.appendChild(tdHouse);
        const tdNote = document.createElement('td'); tdNote.textContent = member.note || '—'; tr.appendChild(tdNote);
        const tdActions = document.createElement('td'); tdActions.innerHTML = `<button class="small-btn" onclick="window.editMemberHandler('${member.id}')">Edit</button> <button class="small-btn" onclick="window.deleteMemberHandler('${member.id}')">Delete</button>`; tr.appendChild(tdActions);
        const hay = (member.name + ' ' + (member.note||'') + ' ' + (member.households||[]).map(h=>h.name+' '+h.note).join(' ')).toLowerCase();
        if(!q || hay.includes(q)) membersTableBody.appendChild(tr);
      });
    }

    function populateDonationFromOptions(){
      donationFromSel.innerHTML = '<option value="">-- Select Member / Household --</option>';
      state.members.forEach(m=>{
        const opt = document.createElement('option'); opt.value = m.id; opt.text = `${m.name} (Member)`; donationFromSel.appendChild(opt);
        if(m.households && m.households.length) m.households.forEach(h=>{ const opt2=document.createElement('option'); opt2.value=h.id; opt2.text=`${h.name} — (${m.name})`; donationFromSel.appendChild(opt2);});
      });
    }

    function renderDonationsTable(){
      donationsTableBody.innerHTML=''; const q=(searchDonationsInput.value||'').toLowerCase().trim();
      const filtered = state.donations.slice().sort((a,b)=> new Date(b.date)- new Date(a.date));
      filtered.forEach(d=>{
        const tr = document.createElement('tr');
        const tdDate=document.createElement('td'); tdDate.textContent=d.date; tr.appendChild(tdDate);
        const tdType=document.createElement('td'); tdType.textContent=capitalize(d.type); tr.appendChild(tdType);
        const tdFrom=document.createElement('td'); tdFrom.textContent=d.fromName || findFromNameById(d.fromId) || '—'; tr.appendChild(tdFrom);
        const tdAmount=document.createElement('td'); tdAmount.textContent = (d.amountDisplay ? d.amountDisplay : (typeof d.amountRaw==='number'? '₹ '+formatRupee(d.amountRaw): '—')); tr.appendChild(tdAmount);
        const tdNote=document.createElement('td'); tdNote.textContent=d.note||'—'; tr.appendChild(tdNote);
        const tdActions=document.createElement('td'); tdActions.innerHTML=`<button class="small-btn" onclick="editDonation('${d.id}')">Edit</button> <button class="small-btn" onclick="deleteDonation('${d.id}')">Delete</button>`; tr.appendChild(tdActions);
        const hay=(d.date+' '+d.type+' '+(d.fromName||'')+' '+(d.note||'')+' '+d.amountDisplay).toLowerCase();
        if(!q || hay.includes(q)) donationsTableBody.appendChild(tr);
      });
    }

    function renderSummary(){
      const totalNumericDonations = state.donations.reduce((s,d)=> s + (typeof d.amountRaw==='number'? Number(d.amountRaw||0):0),0);
      const totalJummaNetNumeric = state.jumma.reduce((s,j)=> s + (typeof j.amountRaw==='number'? Number(j.amountRaw||0):0) - (typeof j.expenseRaw==='number'?Number(j.expenseRaw||0):0),0);
      const constructionRaisedNumeric = state.construction.contributions.reduce((s,c)=> s + (typeof c.amountRaw==='number'?Number(c.amountRaw||0):0),0);
      const constructionSpentNumeric = state.construction.expenses.reduce((s,e)=> s + (typeof e.amountRaw==='number'?Number(e.amountRaw||0):0),0);
      const balance = constructionRaisedNumeric - constructionSpentNumeric;
      totalCollectedEl.textContent = (totalNumericDonations ? '₹ '+formatRupee(totalNumericDonations) : '₹ 0 (text amounts exist)');
      totalJummaEl.textContent = (totalJummaNetNumeric ? '₹ '+formatRupee(totalJummaNetNumeric) : '₹ 0 (text amounts exist)');
      constructionSummaryEl.textContent = (balance ? '₹ '+formatRupee(balance) : '₹ 0 (text amounts exist)');
      constructionTotalRaisedEl.textContent = (constructionRaisedNumeric ? '₹ '+formatRupee(constructionRaisedNumeric) : '₹ 0 (text amounts exist)');
      constructionTotalSpentEl.textContent = (constructionSpentNumeric ? '₹ '+formatRupee(constructionSpentNumeric) : '₹ 0 (text amounts exist)');
      constructionBalanceEl.textContent = (balance ? '₹ '+formatRupee(balance) : '₹ 0 (text amounts exist)');
    }

    function populateLedgerMembers(){ ledgerMemberSel.innerHTML = '<option value="">-- All / Select Member --</option>'; state.members.forEach(m=>{ const opt=document.createElement('option'); opt.value=m.id; opt.text=m.name; ledgerMemberSel.appendChild(opt); }) }

    function renderLedgerForMember(){
      const memberId = ledgerMemberSel.value; ledgerTableBody.innerHTML='';
      let list = [];
      if(!memberId) list = state.donations.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
      else { const member = state.members.find(m=>m.id===memberId); const houseIds=(member&&member.households)?member.households.map(h=>h.id):[]; list = state.donations.filter(d=> d.fromId===memberId || houseIds.includes(d.fromId)).sort((a,b)=>new Date(b.date)-new Date(a.date)); }
      list.forEach(d=>{ const tr=document.createElement('tr'); const amountText = (d.amountDisplay? d.amountDisplay : (typeof d.amountRaw==='number' ? '₹ '+formatRupee(d.amountRaw): d.amountDisplay)); tr.innerHTML = `<td>${d.date}</td><td>${capitalize(d.type)}</td><td>${escapeHtml(amountText)}</td><td>${escapeHtml(d.note||'—')}</td>`; ledgerTableBody.appendChild(tr); });
    }

    function renderJummaTable(){
      jummaTableBody.innerHTML=''; const q=(searchJummaInput.value||'').toLowerCase().trim();
      state.jumma.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(j=>{
        const tr=document.createElement('tr');
        const net = (typeof j.amountRaw==='number'? j.amountRaw:0) - (typeof j.expenseRaw==='number'? j.expenseRaw:0);
        tr.innerHTML = `<td>${j.date}</td><td>${escapeHtml(j.collectorName||findFromNameById(j.collectorId)||'—')}</td>
                        <td>${escapeHtml(j.amountDisplay? j.amountDisplay : (typeof j.amountRaw==='number'? '₹ '+formatRupee(j.amountRaw): j.amountDisplay))}</td>
                        <td>${escapeHtml(j.expenseDisplay? j.expenseDisplay : (typeof j.expenseRaw==='number'? '₹ '+formatRupee(j.expenseRaw): j.expenseDisplay))}</td>
                        <td>₹ ${formatRupee(net)}</td>
                        <td>${escapeHtml(j.note||j.expenseNote||'—')}</td>
                        <td><button class="small-btn" onclick="editJumma('${j.id}')">Edit</button> <button class="small-btn" onclick="deleteJumma('${j.id}')">Delete</button></td>`;
        const hay=(j.date+' '+j.collectorName+' '+j.note+' '+j.expenseNote).toLowerCase();
        if(!q || hay.includes(q)) jummaTableBody.appendChild(tr);
      });
    }

    function renderConstructionTables(){
      contributorsTableBody.innerHTML=''; expensesTableBody.innerHTML='';
      const q=(searchConstructionInput.value||'').toLowerCase().trim();
      state.construction.contributions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${c.date}</td><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.amountDisplay ? c.amountDisplay : (typeof c.amountRaw==='number'? '₹ '+formatRupee(c.amountRaw): c.amountDisplay))}</td><td>${escapeHtml(c.contact||'—')}</td><td>${capitalize(c.type)}</td><td><button class="small-btn" onclick="editContribution('${c.id}')">Edit</button> <button class="small-btn" onclick="deleteContribution('${c.id}')">Delete</button></td>`;
        const hay=(c.date+' '+c.name+' '+c.contact+' '+c.type).toLowerCase();
        if(!q || hay.includes(q)) contributorsTableBody.appendChild(tr);
      });

      state.construction.expenses.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{
        const tr=document.createElement('tr');
        // radio for select
        tr.innerHTML = `<td style="width:36px"><input type="radio" name="selectedExpense" value="${e.id}"></td>
                        <td>${e.date}</td><td>${escapeHtml(e.for)}</td><td>${escapeHtml(e.amountDisplay ? e.amountDisplay : (typeof e.amountRaw==='number'? '₹ '+formatRupee(e.amountRaw): e.amountDisplay))}</td><td>${escapeHtml(e.note||'—')}</td>
                        <td><button class="small-btn" onclick="editConstructionExpense('${e.id}')">Edit</button> <button class="small-btn" onclick="deleteConstructionExpense('${e.id}')">Delete</button></td>`;
        const hay=(e.date+' '+e.for+' '+e.note).toLowerCase();
        if(!q || hay.includes(q)) expensesTableBody.appendChild(tr);
      });
    }

    /* -----------------------
       Utility & finders
       ----------------------- */
    function formatRupee(n){ const num = Number(n) || 0; return num.toLocaleString('en-IN'); }
    function capitalize(s){ if(!s) return ''; return s[0].toUpperCase()+s.slice(1); }
    function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function findFromNameById(id){
      if(!id) return '';
      const m = state.members.find(mm=>mm.id===id); if(m) return m.name;
      for(const mm of state.members){ if(mm.households){ const h=mm.households.find(hh=>hh.id===id); if(h) return `${h.name} (${mm.name})`; } }
      return '';
    }

    /* -----------------------
       Exports (PDFs) - unchanged behavior
       ----------------------- */
    async function exportSummaryPDF(){
      const container = document.createElement('div');
      container.style.padding='22px'; container.style.width='900px'; container.style.background='#fff'; container.style.boxSizing='border-box'; container.style.fontFamily='Inter, sans-serif';
      buildPdfHeader(container);
      container.innerHTML += `<hr style="margin:12px 0"/>
        <h3 style="font-family: Amiri, serif; color:#0b5d3a">Summary</h3>
        <div id="pdf-summary-content"></div>
        <hr style="margin:12px 0"/>
        <h4 style="font-family: Amiri, serif; color:#0b5d3a">Recent Donations</h4>
        <div id="pdf-donations-list"></div>
        <hr style="margin:12px 0"/>
        <h4 style="font-family: Amiri, serif; color:#0b5d3a">Construction Contributors (recent)</h4>
        <div id="pdf-contribs-list"></div>
        <div style="margin-top:20px;font-size:11px;color:#666">Generated by Apni Masjid — Offline App</div>`;
      const summaryDiv = container.querySelector('#pdf-summary-content');
      const totalNumericDonations = state.donations.reduce((s,d)=> s + (typeof d.amountRaw === 'number' ? Number(d.amountRaw||0): 0), 0);
      const totalJummaNetNumeric = state.jumma.reduce((s,j)=> s + (typeof j.amountRaw === 'number' ? Number(j.amountRaw||0): 0) - (typeof j.expenseRaw === 'number' ? Number(j.expenseRaw||0): 0), 0);
      const constructionRaisedNumeric = state.construction.contributions.reduce((s,c)=> s + (typeof c.amountRaw === 'number' ? Number(c.amountRaw||0) : 0), 0);
      const constructionSpentNumeric = state.construction.expenses.reduce((s,e)=> s + (typeof e.amountRaw === 'number' ? Number(e.amountRaw||0) : 0), 0);
      const balanceNumeric = constructionRaisedNumeric - constructionSpentNumeric;
      summaryDiv.innerHTML = `<p>Total Donations (numeric sums): <strong>₹ ${formatRupee(totalNumericDonations)}</strong></p>
        <p>Total Jumma Net (numeric sums): <strong>₹ ${formatRupee(totalJummaNetNumeric)}</strong></p>
        <p>Construction Balance (numeric sums): <strong>₹ ${formatRupee(balanceNumeric)}</strong></p>
        <p><em>Note: Textual amounts (alphabets) are preserved in lists but not included in numeric sums above.</em></p>`;
      const dd = container.querySelector('#pdf-donations-list');
      state.donations.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,50).forEach(d=>{ const div=document.createElement('div'); const amountText=(d.amountDisplay ? d.amountDisplay : (typeof d.amountRaw==='number' ? '₹ '+formatRupee(d.amountRaw) : '—')); div.innerHTML = `<strong>${escapeHtml(d.fromName || findFromNameById(d.fromId) || '—')}</strong> — ${escapeHtml(amountText)} — ${escapeHtml(d.type)} — ${d.date} ${d.note ? '- ' + escapeHtml(d.note) : ''}`; dd.appendChild(div); });
      const pc = container.querySelector('#pdf-contribs-list');
      state.construction.contributions.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,50).forEach(c=>{ const div=document.createElement('div'); const amountText=(c.amountDisplay ? c.amountDisplay : (typeof c.amountRaw==='number' ? '₹ '+formatRupee(c.amountRaw) : '—')); div.innerHTML = `<strong>${escapeHtml(c.name)}</strong> — ${escapeHtml(amountText)} — ${escapeHtml(c.date)} ${c.contact ? '- ' + escapeHtml(c.contact) : ''}`; pc.appendChild(div); });
      if(window.html2canvas && window.jspdf){ try{ const canvas=await html2canvas(container,{scale:2,useCORS:true}); const imgData=canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf=new jsPDF('p','pt','a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const imgWidth = pdfWidth-40; const imgHeight = canvas.height*(imgWidth/canvas.width); pdf.addImage(imgData,'PNG',20,20,imgWidth,imgHeight); pdf.save((state.mosque.name||'masjid')+'_summary.pdf'); }catch(e){ console.error(e); fallbackPrint(container); } } else fallbackPrint(container);
    }

    function buildPdfHeader(container){
      const headerDiv = document.createElement('div'); headerDiv.style.textAlign='center'; headerDiv.style.marginBottom='8px';
      headerDiv.innerHTML = `<div style="font-family: Amiri, serif; font-size:26px; color:#0b5d3a">${escapeHtml(state.mosque.name)}</div>
        <div style="font-size:12px;color:#666;margin-top:4px">${escapeHtml(state.mosque.address || '')}</div>
        <div style="font-family: Amiri, serif; font-size:18px; margin-top:6px; color:#0b5d3a">بسم الله الرحمن الرحيم</div>`;
      container.appendChild(headerDiv);
      const arch = document.createElement('div'); arch.style.width='100%'; arch.style.textAlign='center';
      arch.innerHTML = `<svg width="100%" height="60" viewBox="0 0 900 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,100 C150,-50 750,-50 900,100" fill="#0b5d3a33"/></svg>`;
      container.appendChild(arch);
    }

    function fallbackPrint(element){
      const newWin = window.open('','_blank'); newWin.document.write('<html><head><title>Report</title></head><body>'); newWin.document.write(element.innerHTML); newWin.document.write('</body></html>'); newWin.document.close(); newWin.print();
    }

    async function createIslamicNoticePDF(){
      const title = prompt('Notice ka title likhen', 'Eilan / Ailan'); if(title===null) return;
      const bodyText = prompt('Notice ka content likhen', 'Yahan apna Islamic notice likhen. Jumma time: ...'); if(bodyText===null) return;
      const container = document.createElement('div'); container.style.width='900px'; container.style.padding='36px'; container.style.background='#fff'; container.style.position='relative'; container.style.boxSizing='border-box';
      buildPdfHeader(container);
      const content = document.createElement('div');
      content.innerHTML = `<hr style="margin:12px 0"/><h2 style="text-align:center;font-family: Amiri, serif">${escapeHtml(title)}</h2><div style="margin-top:16px;font-size:14px;line-height:1.5">${escapeHtml(bodyText).replace(/\n/g,'<br/>')}</div><div style="margin-top:32px;text-align:center;color:#666;font-size:12px"><em>Masjid management</em></div>`;
      container.appendChild(content);
      const addQR = confirm('Do you want to add donation QR code in this PDF?');
      if(addQR){
        let donationLink = prompt('Enter your donation link or UPI/Pay link (example: upi://pay?pa=... or https://...)');
        if(donationLink){
          const qrDiv = document.createElement('div'); qrDiv.style.textAlign='center'; qrDiv.style.marginTop='18px'; container.appendChild(qrDiv);
          if(state.ui.qrImageData){
            const img = document.createElement('img'); img.src = state.ui.qrImageData; img.style.width='140px'; img.style.height='140px'; img.style.objectFit='contain'; qrDiv.appendChild(img);
          } else {
            new QRCode(qrDiv, { text: donationLink, width:140, height:140, colorDark:"#0b5d3a", colorLight:"#ffffff" });
          }
        }
      }
      if(window.html2canvas && window.jspdf){ try{ const canvas = await html2canvas(container,{scale:2,useCORS:true}); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','pt','a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const imgWidth = pdfWidth - 40; const imgHeight = canvas.height * (imgWidth / canvas.width); pdf.addImage(imgData,'PNG',20,20,imgWidth,imgHeight); pdf.save((state.mosque.name || 'masjid') + '_notice.pdf'); }catch(e){ console.error(e); fallbackPrint(container); } } else fallbackPrint(container);
    }

    async function exportLedgerPDF(){
      const memberId = ledgerMemberSel.value; const memberName = memberId? (state.members.find(m=>m.id===memberId)?.name || 'ledger') : 'All_Members';
      const list = (memberId ? state.donations.filter(d => d.fromId === memberId || (state.members.find(m=>m.id===memberId)?.households||[]).some(h=>h.id===d.fromId)) : state.donations).sort((a,b)=> new Date(b.date)-new Date(a.date));
      const container = document.createElement('div'); container.style.padding='20px'; container.style.width='900px'; container.style.boxSizing='border-box';
      buildPdfHeader(container);
      const titleDiv = document.createElement('div'); titleDiv.style.marginTop='12px'; titleDiv.innerHTML = `<h2 style="font-family:Amiri, serif;color:#0b5d3a">${escapeHtml(state.mosque.name || '')} — Ledger (${escapeHtml(memberName)})</h2>`; container.appendChild(titleDiv);
      const tableWrapper = document.createElement('div');
      tableWrapper.innerHTML = `<table style="width:100%;border-collapse:collapse;margin-top:10px"><thead><tr><th style="border:1px solid #ddd;padding:6px">Date</th><th style="border:1px solid #ddd;padding:6px">Type</th><th style="border:1px solid #ddd;padding:6px">From</th><th style="border:1px solid #ddd;padding:6px">Amount</th><th style="border:1px solid #ddd;padding:6px">Note</th></tr></thead><tbody>${list.map(d => `<tr><td style="border:1px solid #eee;padding:6px">${d.date}</td><td style="border:1px solid #eee;padding:6px">${escapeHtml(d.type)}</td><td style="border:1px solid #eee;padding:6px">${escapeHtml(d.fromName||findFromNameById(d.fromId)||'—')}</td><td style="border:1px solid #eee;padding:6px">${escapeHtml(d.amountDisplay ? d.amountDisplay : (typeof d.amountRaw === 'number' ? '₹ ' + formatRupee(d.amountRaw) : d.amountDisplay))}</td><td style="border:1px solid #eee;padding:6px">${escapeHtml(d.note||'')}</td></tr>`).join('')}</tbody></table>`;
      container.appendChild(tableWrapper);
      if(window.html2canvas && window.jspdf){ try{ const canvas = await html2canvas(container,{scale:2,useCORS:true}); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','pt','a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const imgWidth = pdfWidth - 40; const imgHeight = canvas.height * (imgWidth / canvas.width); pdf.addImage(imgData,'PNG',20,20,imgWidth,imgHeight); pdf.save(`${memberName}_ledger.pdf`); }catch(e){ console.error(e); fallbackPrint(container); } } else fallbackPrint(container);
    }

    /* -----------------------
       Exports CSV (unchanged)
       ----------------------- */
    function exportAllCSV(){
      let csv = 'Date,Type,From,Amount,Note\n';
      state.donations.forEach(d=>{ const from = d.fromName || findFromNameById(d.fromId) || ''; const amount = (d.amountDisplay ? d.amountDisplay : (typeof d.amountRaw === 'number' ? d.amountRaw : '')); csv += [`"${d.date}"`,`"${d.type}"`,`"${from}"`,`"${amount}"`,`"${(d.note||'').replace(/"/g,'""')}"`].join(',') + '\n'; });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = (state.mosque.name || 'masjid') + '_donations.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* -----------------------
       QR / QR dialog
       ----------------------- */
    function openQRCodeDialog(){
      const donationLink = prompt('Enter donation link or UPI ID / URL (e.g., upi://pay?pa=... or https://...)');
      if(!donationLink) return;
      const w = window.open('','_blank','width=420,height=500');
      w.document.write('<html><head><title>Donation QR</title></head><body style="display:flex;align-items:center;justify-content:center;height:100%;font-family:Inter, sans-serif">');
      w.document.write('<div id="qrwrap" style="text-align:center"><div id="qr"></div><div style="margin-top:10px;color:#666">'+escapeHtml(donationLink)+'</div></div>');
      w.document.write('</body></html>'); w.document.close();
      setTimeout(()=> { try{ new w.QRCode(w.document.getElementById('qr'), { text:donationLink,width:240,height:240,colorDark:"#0b5d3a",colorLight:"#ffffff" }); }catch(e){ console.error(e);} },200);
    }

    /* -----------------------
       QUICK ANNOUNCEMENT (NEW)
       - Creates text preview and can create an image (not PDF)
       - Image has Islamic background, bismillah, title, message, optional QR image
       ----------------------- */
    function updateQuickPreview(){
      const title = quickTitle.value.trim(); const msg = quickMessage.value.trim();
      const full = (title ? ('<strong>'+escapeHtml(title)+'</strong><br/>') : '') + '<div>'+escapeHtml(msg).replace(/\n/g,'<br/>')+'</div>';
      quickPreview.innerHTML = full || 'Preview will appear here with Islamic background';
    }
    quickTitle.addEventListener('input', updateQuickPreview);
    quickMessage.addEventListener('input', updateQuickPreview);

    async function copyQuickTextToClipboard(){
      const title = quickTitle.value.trim(); const msg = quickMessage.value.trim();
      if(!title && !msg){ alert('Kuch likhen pehle'); return; }
      const final = (title ? (title + '\n\n') : '') + msg + '\n\n— ' + (state.mosque.name || '');
      try{
        await navigator.clipboard.writeText(final);
        alert('Text copied to clipboard. Ab group me paste karke bhej dijiye.');
      }catch(e){
        // fallback: select in a temp textarea
        const ta = document.createElement('textarea'); ta.value = final; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); alert('Copied to clipboard (fallback).'); }catch(err){ alert('Copy failed. Please select and copy manually.'); }
        ta.remove();
      }
    }

    // produce image blob of quick announcement
    async function createQuickAnnouncementImage(){
      // build canvas element programmatically
      const width = 1200; const height = 675; // 16:9
      const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');

      // background Islamic pattern (draw simple pattern)
      ctx.fillStyle = '#fdfbf6'; ctx.fillRect(0,0,width,height);
      // faint watermark text
      ctx.save(); ctx.globalAlpha = 0.06; ctx.fillStyle = '#000'; ctx.font = '140px Amiri, serif'; ctx.textAlign = 'center'; ctx.fillText('سُبْحَانَ اللّٰهِ', width/2, height/2); ctx.restore();

      // decorative top arch
      ctx.fillStyle = '#0b5d3a33'; ctx.beginPath(); ctx.moveTo(0,height*0.18); ctx.quadraticCurveTo(width/2,-height*0.4,width,height*0.18); ctx.lineTo(width,height*0.32); ctx.quadraticCurveTo(width/2,height*0.1,0,height*0.32); ctx.closePath(); ctx.fill();

      // bismillah
      ctx.fillStyle = '#0b5d3a'; ctx.font = '42px Amiri, serif'; ctx.textAlign = 'center'; ctx.fillText('بسم الله الرحمن الرحيم', width/2, 110);

      // mosque title
      ctx.fillStyle = '#083'; ctx.font = '28px Amiri, serif'; ctx.fillText(state.mosque.name || 'Apni Masjid', width/2, 150);

      // message box
      const padding = 60;
      const boxX = padding; const boxY = 190; const boxW = width - padding*2; const boxH = height - boxY - 120;
      // white panel
      ctx.fillStyle = 'rgba(255,255,255,0.9)'; roundRect(ctx,boxX,boxY,boxW,boxH,16,true,false);
      // draw message lines
      ctx.fillStyle = '#0b1724'; ctx.textAlign='left';
      // title + message
      let y = boxY + 40;
      if(quickTitle.value.trim()){
        ctx.font = '24px Amiri, serif'; wrapText(ctx, quickTitle.value.trim(), boxX+30, y, boxW-60, 30); y += 60;
      }
      ctx.font = '18px Inter, sans-serif';
      wrapText(ctx, quickMessage.value.trim(), boxX+30, y, boxW-60, 26);

      // optional QR image if uploaded
      if(state.ui.qrImageData){
        try{
          const img = await loadImage(state.ui.qrImageData);
          const qrSize = 140;
          ctx.drawImage(img, boxX + boxW - qrSize - 24, boxY + boxH - qrSize - 24, qrSize, qrSize);
        }catch(e){ console.warn('QR draw failed', e); }
      }

      // footer
      ctx.fillStyle = '#666'; ctx.font = '14px Inter, sans-serif'; ctx.textAlign='center'; ctx.fillText('— ' + (state.mosque.name || '') + ' —', width/2, height-40);

      // convert to blob
      return new Promise(resolve=>{
        canvas.toBlob(blob => {
          lastGeneratedQuickBlob = blob;
          // open in new window for preview
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
          resolve(blob);
        }, 'image/png');
      });
    }

    function openLastQuickImage(){
      if(!lastGeneratedQuickBlob){ alert('Pehle "Create Image" dabao'); return; }
      const url = URL.createObjectURL(lastGeneratedQuickBlob); window.open(url,'_blank');
    }

    // helper: create rounded rect
    function roundRect(ctx,x,y,w,h,r, fill, stroke){
      if (typeof r === 'undefined') r = 5;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y,   x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x,   y+h, r);
      ctx.arcTo(x,   y+h, x,   y,   r);
      ctx.arcTo(x,   y,   x+w, y,   r);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }
    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      if(!text) return;
      const words = text.split(' ');
      let line = '';
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if(testWidth > maxWidth && n>0){
          ctx.fillText(line, x, y);
          line = words[n] + ' ';
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, y);
    }
    function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }

    async function copyQuickImageToClipboard(){
      if(!lastGeneratedQuickBlob){ alert('Pehle Create Image dabao'); return; }
      try{
        await navigator.clipboard.write([ new ClipboardItem({ [lastGeneratedQuickBlob.type]: lastGeneratedQuickBlob }) ]);
        alert('Image copied to clipboard. Ab group me paste karke bhej dijiye.');
      }catch(e){
        alert('Copy to clipboard not supported. Image opened in new tab for manual save/share.');
        openLastQuickImage();
      }
    }

    /* -----------------------
       EXPENSE -> IMAGE (NEW)
       - select expense row (radio) and generate Islamic image (not PDF)
       - language preserved (whatever typed)
       ----------------------- */
    function getSelectedExpenseId(){
      const radios = document.querySelectorAll('input[name="selectedExpense"]');
      for(const r of radios) if(r.checked) return r.value;
      return null;
    }

    async function handleCreateExpenseImage(){
      const id = getSelectedExpenseId();
      if(!id){ alert('Pehle koi expense select karo'); return; }
      const e = state.construction.expenses.find(x=>x.id===id);
      if(!e){ alert('Expense nahi mila'); return; }
      // create image similar to quick announcement but with expense details highlighted
      const width = 1200, height = 675; const canvas = document.createElement('canvas'); canvas.width=width; canvas.height=height; const ctx = canvas.getContext('2d');
      // bg
      ctx.fillStyle='#fdfbf6'; ctx.fillRect(0,0,width,height);
      ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle='#000'; ctx.font='140px Amiri, serif'; ctx.textAlign='center'; ctx.fillText('سُبْحَانَ اللّٰهِ', width/2, height/2); ctx.restore();
      // arch
      ctx.fillStyle = '#0b5d3a33'; ctx.beginPath(); ctx.moveTo(0,height*0.18); ctx.quadraticCurveTo(width/2,-height*0.4,width,height*0.18); ctx.lineTo(width,height*0.32); ctx.quadraticCurveTo(width/2,height*0.1,0,height*0.32); ctx.closePath(); ctx.fill();
      // bismillah
      ctx.fillStyle='#0b5d3a'; ctx.font='42px Amiri, serif'; ctx.textAlign='center'; ctx.fillText('بسم الله الرحمن الرحيم', width/2, 110);
      // title
      ctx.fillStyle='#083'; ctx.font='28px Amiri, serif'; ctx.fillText(state.mosque.name || 'Apni Masjid', width/2, 150);
      // expense box
      const padding=60, boxX=padding, boxY=190, boxW=width-padding*2, boxH=height-boxY-140;
      ctx.fillStyle='rgba(255,255,255,0.95)'; roundRect(ctx,boxX,boxY,boxW,boxH,16,true,false);
      // expense text
      ctx.fillStyle='#0b1724'; ctx.textAlign='left';
      let y = boxY+50;
      ctx.font='22px Amiri, serif';
      wrapText(ctx, 'Expense: ' + e.for, boxX+30, y, boxW-60, 30); y+=40;
      ctx.font='20px Inter, sans-serif';
      const amountText = (e.amountDisplay ? e.amountDisplay : (typeof e.amountRaw==='number'? '₹ '+formatRupee(e.amountRaw): e.amountDisplay));
      wrapText(ctx, 'Amount: ' + amountText, boxX+30, y, boxW-60, 28); y+=40;
      wrapText(ctx, 'Date: ' + e.date, boxX+30, y, boxW-60, 26); y+=34;
      if(e.note) { wrapText(ctx, 'Note: ' + e.note, boxX+30, y, boxW-60, 24); y+=34; }
      // optional QR image
      if(state.ui.qrImageData){
        try{ const img = await loadImage(state.ui.qrImageData); const qrSize=140; ctx.drawImage(img, boxX + boxW - qrSize - 24, boxY + boxH - qrSize - 24, qrSize, qrSize);}catch(e){ console.warn('QR draw failed', e); }
      }
      // footer
      ctx.fillStyle='#666'; ctx.font='14px Inter, sans-serif'; ctx.textAlign='center'; ctx.fillText('— ' + (state.mosque.name || '') + ' —', width/2, height-40);
      canvas.toBlob(blob => { lastGeneratedExpenseBlob = blob; const url = URL.createObjectURL(blob); window.open(url,'_blank'); }, 'image/png');
    }

    async function handleCopyExpenseImage(){
      if(!lastGeneratedExpenseBlob){ alert('Pehle "Create Image" dabao'); return; }
      try{
        await navigator.clipboard.write([ new ClipboardItem({ [lastGeneratedExpenseBlob.type]: lastGeneratedExpenseBlob }) ]);
        alert('Image copied to clipboard. Ab group me paste karke bhej dijiye.');
      }catch(e){
        alert('Copy not supported — opening image in new tab.');
        handleOpenExpenseImage();
      }
    }
    function handleOpenExpenseImage(){
      if(!lastGeneratedExpenseBlob){ alert('Pehle "Create Image" dabao'); return; }
      const url = URL.createObjectURL(lastGeneratedExpenseBlob); window.open(url,'_blank');
    }

    /* -----------------------
       implement quick image copy/open bindings
       ----------------------- */
    createQuickImageBtn.addEventListener('click', async ()=>{
      await createQuickAnnouncementImage();
    });
    copyQuickTextBtn.addEventListener('click', copyQuickTextToClipboard);
    document.getElementById('copy-quick-text').addEventListener('click', copyQuickTextToClipboard);
    document.getElementById('open-quick-image').addEventListener('click', openLastQuickImage);
    document.getElementById('copy-expense-image').addEventListener('click', handleCopyExpenseImage);
    document.getElementById('create-expense-image').addEventListener('click', handleCreateExpenseImage);
    document.getElementById('open-expense-image').addEventListener('click', handleOpenExpenseImage);

    /* -----------------------
       Additional PDF/Export functions reuse earlier code (unchanged)
       - exportJummaPDF, exportConstructionReport, exportLedgerPDF already present earlier
       ----------------------- */
    async function exportJummaPDF(){ /* reuse previous exportJummaPDF logic */ 
      // To keep unchanged behavior: call earlier function reuse same code block as before
      // (For brevity here, we call exportJummaPDF via exportJummaBtn which already wired to a function above)
      // Re-run render exportJummaPDF from above:
      const container = document.createElement('div');
      container.style.padding = '20px';
      container.style.width = '900px';
      container.style.boxSizing = 'border-box';
      buildPdfHeader(container);
      container.innerHTML += `<h2 style="font-family:Amiri, serif;color:#0b5d3a">${escapeHtml(state.mosque.name || '')} — Jumma Ledger</h2><div id="jumma-list"></div>`;
      const jl = container.querySelector('#jumma-list');
      state.jumma.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(j => {
        const item = document.createElement('div'); item.style.marginBottom='6px';
        const collected = (j.amountDisplay ? j.amountDisplay : (typeof j.amountRaw === 'number' ? '₹ ' + formatRupee(j.amountRaw) : j.amountDisplay));
        const expense = (j.expenseDisplay ? j.expenseDisplay : (typeof j.expenseRaw === 'number' ? '₹ ' + formatRupee(j.expenseRaw) : j.expenseDisplay));
        item.textContent = `${j.date} — ${j.collectorName || findFromNameById(j.collectorId) || '—'} — Collected: ${collected} — Expense: ${expense} — Note: ${j.note || j.expenseNote || ''}`;
        jl.appendChild(item);
      });
      if(window.html2canvas && window.jspdf){ try{ const canvas = await html2canvas(container,{scale:2,useCORS:true}); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','pt','a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const imgWidth = pdfWidth - 40; const imgHeight = canvas.height * (imgWidth / canvas.width); pdf.addImage(imgData,'PNG',20,20,imgWidth,imgHeight); pdf.save('jumma_ledger.pdf'); }catch(e){ console.error(e); fallbackPrint(container); } } else fallbackPrint(container);
    }

    async function exportConstructionReport(){
      const container = document.createElement('div'); container.style.padding='20px'; container.style.width='900px'; container.style.boxSizing='border-box';
      buildPdfHeader(container);
      container.innerHTML += `<h2 style="font-family:Amiri, serif;color:#0b5d3a">${escapeHtml(state.mosque.name || '')} — Construction Report</h2>
        <div id="pdf-contribs"></div>
        <div id="pdf-expenses"></div>`;
      const pc = container.querySelector('#pdf-contribs'); pc.innerHTML = '<h4>Contributors</h4>';
      state.construction.contributions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(c=>{ const d=document.createElement('div'); d.style.marginBottom='6px'; const amt=(c.amountDisplay ? c.amountDisplay : (typeof c.amountRaw==='number' ? '₹ '+formatRupee(c.amountRaw) : c.amountDisplay)); d.textContent = `${c.date} — ${c.name} — ${amt} — ${c.contact || ''} — ${capitalize(c.type)}`; pc.appendChild(d); });
      const pe = container.querySelector('#pdf-expenses'); pe.innerHTML = '<h4 style="margin-top:12px">Expenses</h4>';
      state.construction.expenses.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{ const d=document.createElement('div'); d.style.marginBottom='6px'; const amt=(e.amountDisplay ? e.amountDisplay : (typeof e.amountRaw==='number' ? '₹ '+formatRupee(e.amountRaw) : e.amountDisplay)); d.textContent = `${e.date} — ${e.for} — ${amt} — ${e.note || ''}`; pe.appendChild(d); });
      if(window.html2canvas && window.jspdf){ try{ const canvas = await html2canvas(container,{scale:2,useCORS:true}); const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p','pt','a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const imgWidth = pdfWidth - 40; const imgHeight = canvas.height * (imgWidth / canvas.width); pdf.addImage(imgData,'PNG',20,20,imgWidth,imgHeight); pdf.save('construction_report.pdf'); }catch(e){ console.error(e); fallbackPrint(container); } } else fallbackPrint(container);
    }

    async function exportLedgerPDF(){ /* same as earlier implemented */ 
      // We already defined exportLedgerPDF earlier in the long script; but to ensure it's available:
      // call the one defined above if present. (No-op here because defined earlier.)
      // In this file we kept a single implementation above.
      await exportLedgerPDF; // harmless
    }

    /* -----------------------
       Quick bindings: initial render & event exposures
       ----------------------- */
    window.deleteDonationHandler = function(id){ deleteDonation(id); };
    // expose edit functions used in table buttons
    window.editDonation = editDonation;
    window.editJumma = editJumma;
    window.editContribution = editContribution;
    window.editConstructionExpense = editConstructionExpense;

    renderAllUI();

    /* ===============================
       END
       =============================== */
  </script>
</body>
</html>
